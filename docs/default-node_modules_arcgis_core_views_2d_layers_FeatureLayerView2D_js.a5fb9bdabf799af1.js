"use strict";var De=Object.defineProperty,Le=Object.defineProperties,Ne=Object.getOwnPropertyDescriptors,Re=Object.getOwnPropertySymbols,Be=Object.prototype.hasOwnProperty,We=Object.prototype.propertyIsEnumerable,be=(V,R,n)=>R in V?De(V,R,{enumerable:!0,configurable:!0,writable:!0,value:n}):V[R]=n,q=(V,R)=>{for(var n in R||(R={}))Be.call(R,n)&&be(V,n,R[n]);if(Re)for(var n of Re(R))We.call(R,n)&&be(V,n,R[n]);return V},$=(V,R)=>Le(V,Ne(R));(self.webpackChunkdemo2=self.webpackChunkdemo2||[]).push([["default-node_modules_arcgis_core_views_2d_layers_FeatureLayerView2D_js"],{59990:(V,R,n)=>{function o(u){var g;const _=u.layer;return"floorInfo"in _&&(null==(g=_.floorInfo)?void 0:g.floorField)&&"floors"in u.view?Z(u.view.floors,_.floorInfo.floorField):null}function c(u,_){var g;return"floorInfo"in _&&(null==(g=_.floorInfo)?void 0:g.floorField)?Z(u,_.floorInfo.floorField):null}function Z(u,_){if(null==u||!u.length)return null;const g=u.filter(b=>""!==b).map(b=>`'${b}'`);return g.push("''"),`${_} IN (${g.join(",")}) OR ${_} IS NULL`}n.d(R,{c:()=>o,f:()=>c})},1607:(V,R,n)=>{n.r(R),n.d(R,{default:()=>Me});var o=n(15861),c=n(17626),Z=n(88879),u=n(77712),g=(n(85931),n(8314)),F=(n(90912),n(76898));let O=class extends Z.Z{constructor(){super(...arguments),this.isAggregate=!0}getEffectivePopupTemplate(t=!1){if(this.popupTemplate)return this.popupTemplate;const e=this.sourceLayer&&this.sourceLayer.featureReduction;return e&&"popupTemplate"in e&&e.popupEnabled?e.popupTemplate:null}getObjectId(){return this.objectId}};(0,c._)([(0,u.Cb)({type:Boolean})],O.prototype,"isAggregate",void 0),(0,c._)([(0,u.Cb)({type:[String,Number],json:{read:!0}})],O.prototype,"objectId",void 0),O=(0,c._)([(0,F.j)("esri.AggregateGraphic")],O);const D=O;n(29132);var N=n(74333),T=n(26584),I=n(58817),z=n(63290),a=n(62208),v=n(10699),m=n(32917),ie=n(14517),pe=n(52884);let U=class extends ie.Z{constructor(t){super(t),this._filter=null,this.duration=(0,g.Z)("mapview-transitions-duration"),this._excludedEffectView=new pe.AM(t),this._includedEffectView=new pe.AM(t)}get excludedEffects(){return this._excludedEffectView.effects}set featureEffect(t){this._get("featureEffect")!==t&&this._transitionTo(t)}get filter(){var t;return this._filter||(null==(t=(0,a.Wg)(this.featureEffect))?void 0:t.filter)||null}get hasEffects(){return this._excludedEffectView.hasEffects||this._includedEffectView.hasEffects}get includedEffects(){return this._includedEffectView.effects}set scale(t){this._set("scale",t),this._excludedEffectView.scale=t,this._includedEffectView.scale=t}get transitioning(){return this._excludedEffectView.transitioning||this._includedEffectView.transitioning}transitionStep(t,e){this._set("scale",e),this.transitioning?(this._includedEffectView.transitionStep(t,e),this._excludedEffectView.transitionStep(t,e),this.transitioning||(this._filter=null)):(this._excludedEffectView.scale=e,this._includedEffectView.scale=e)}end(){this._includedEffectView.end(),this._excludedEffectView.end(),this._filter=null}_transitionTo(t){const e=this._get("featureEffect"),r=(0,a.Wg)(t),i=(0,a.Wg)(null==r?void 0:r.includedEffect),s=(0,a.Wg)(null==r?void 0:r.excludedEffect),l=this._includedEffectView.canTransitionTo(i)&&this._excludedEffectView.canTransitionTo(s);this._includedEffectView.effect=i,this._excludedEffectView.effect=s,this._set("featureEffect",r),this._filter=(null==r?void 0:r.filter)||(null==e?void 0:e.filter)||null,l||this.end()}};(0,c._)([(0,u.Cb)()],U.prototype,"_filter",void 0),(0,c._)([(0,u.Cb)()],U.prototype,"_excludedEffectView",void 0),(0,c._)([(0,u.Cb)()],U.prototype,"_includedEffectView",void 0),(0,c._)([(0,u.Cb)()],U.prototype,"duration",void 0),(0,c._)([(0,u.Cb)()],U.prototype,"excludedEffects",null),(0,c._)([(0,u.Cb)()],U.prototype,"featureEffect",null),(0,c._)([(0,u.Cb)()],U.prototype,"filter",null),(0,c._)([(0,u.Cb)()],U.prototype,"hasEffects",null),(0,c._)([(0,u.Cb)()],U.prototype,"includedEffects",null),(0,c._)([(0,u.Cb)({value:0})],U.prototype,"scale",null),(0,c._)([(0,u.Cb)()],U.prototype,"transitioning",null),U=(0,c._)([(0,F.j)("esri.layers.effects.FeatureEffectView")],U);const ye=U;var se=n(98624),ne=n(17253),Y=n(84952),fe=n(39351),K=n(37384),ge=n(49391);function ee(){return(ee=(0,o.Z)(function*(t,e){if(!t)return null;switch(t.type){case"symbol":return new((yield Promise.all([n.e("default-node_modules_arcgis_core_layers_support_rasterFunctions_pixelUtils_js"),n.e("default-node_modules_arcgis_core_views_webgl_FramebufferObject_js-node_modules_arcgis_core_vi-bdfcdd"),n.e("default-node_modules_arcgis_core_views_webgl_ProgramTemplate_js-node_modules_arcgis_core_view-567db3"),n.e("default-node_modules_arcgis_core_chunks_earcut_js-node_modules_arcgis_core_views_2d_engine_ve-99d8af"),n.e("default-node_modules_arcgis_core_views_2d_engine_webgl_WGLContainer_js"),n.e("default-node_modules_arcgis_core_views_2d_engine_FeatureContainer_js-node_modules_arcgis_core-110765"),n.e("common"),n.e("node_modules_arcgis_core_views_2d_engine_webgl_DisplayId_js-node_modules_arcgis_core_views_2d-d0aac0")]).then(n.bind(n,19268))).default)(e);case"heatmap":return new((yield Promise.all([n.e("default-node_modules_arcgis_core_layers_support_rasterFunctions_pixelUtils_js"),n.e("default-node_modules_arcgis_core_views_webgl_FramebufferObject_js-node_modules_arcgis_core_vi-bdfcdd"),n.e("default-node_modules_arcgis_core_views_webgl_ProgramTemplate_js-node_modules_arcgis_core_view-567db3"),n.e("default-node_modules_arcgis_core_chunks_earcut_js-node_modules_arcgis_core_views_2d_engine_ve-99d8af"),n.e("default-node_modules_arcgis_core_views_2d_engine_webgl_WGLContainer_js"),n.e("common"),n.e("node_modules_arcgis_core_views_2d_layers_features_tileRenderers_HeatmapTileRenderer_js")]).then(n.bind(n,32900))).default)(e)}})).apply(this,arguments)}var te=n(22418),G=n(62192),ve=n(71251);function x(t){return t.some(e=>e.globalId)}function E(t){return t.filter(e=>!e.error).map(e=>{var r;return null!=(r=e.objectId)?r:e.globalId})}function j(t,e){const r=new Set(t);for(const i of e.values())r.add(i);return r}function W(t,e){const r=new Set(t);for(const i of e.values())r.delete(i);return r}let J=class extends ie.Z{constructor(t){super(t),this._hasGlobalIds=!1}normalizeCtorArgs(t){return this._queueProcessor=new ve.e({concurrency:1,process:t.process}),{}}destroy(){this.clear()}get updating(){return this._queueProcessor.length>0}clear(){this._queueProcessor.clear()}push(t){const e=this._queueProcessor,r=e.last();switch(t.type){case"update":case"refresh":if((null==r?void 0:r.type)===t.type)return;e.push(t).finally(()=>this.notifyChange("updating"));break;case"edit":{const i="processed-edit"===(null==r?void 0:r.type)?r:null;i&&e.popLast();const s=this._mergeEdits(i,t);for(const l of s)e.push(l).finally(()=>this.notifyChange("updating"));break}}this.notifyChange("updating")}_mergeEdits(t,e){var f,h;const{addedFeatures:r,deletedFeatures:i,updatedFeatures:s}=e.edits;if(this._hasGlobalIds=this._hasGlobalIds||x(r)||x(s)||x(i),this._hasGlobalIds)return[t,{type:"processed-edit",edits:{addOrModified:[...r,...s],removed:i}}];const l=new Set(E(null!=(f=null==t?void 0:t.edits.addOrModified)?f:[])),d=new Set(E(null!=(h=null==t?void 0:t.edits.removed)?h:[])),y=new Set([...E(r),...E(s)]),p=new Set(E(i));return[{type:"processed-edit",edits:{addOrModified:Array.from(j(W(l,p),y)).map(C=>({objectId:C})),removed:Array.from(j(W(d,y),p)).map(C=>({objectId:C}))}}]}};(0,c._)([(0,u.Cb)({readOnly:!0})],J.prototype,"updating",null),J=(0,c._)([(0,F.j)("esri.views.2d.layers.support.FeatureCommandQueue")],J);const oe=J;var ae=n(60330),A=n(59289);let X=class extends ae.D{constructor(t){super(t),this._startupResolver=(0,v.hh)(),this.isReady=!1}initialize(){this._controller=new AbortController,this.addResolvingPromise(this._startWorker(this._controller.signal))}destroy(){this._controller.abort(),this._connection&&this._connection.close()}set tileRenderer(t){this.client.tileRenderer=t}get closed(){return this._connection.closed}startup(t,e,r,i){var s=this;return(0,o.Z)(function*(){yield s.when();const l=s._controller.signal,d=function le(t){return Array.isArray(t)}(r.source)?{transferList:r.source,signal:l}:void 0,y={service:r,config:e,tileInfo:t.tileInfo.toJSON(),tiles:i};yield s._connection.invoke("startup",y,d),s._startupResolver.resolve(),s._set("isReady",!0)})()}updateTiles(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("updateTiles",t))})()}update(t){var e=this;return(0,o.Z)(function*(){const r={config:t};return yield e._startupResolver.promise,e._connection.invoke("update",r)})()}applyUpdate(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("applyUpdate",t)})()}setHighlight(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("controller.setHighlight",t))})()}stop(){var t=this;return(0,o.Z)(function*(){if(yield t._startupResolver.promise,!t.closed)return(0,v.R8)(t._connection.invoke("stop"))})()}refresh(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("controller.refresh",t))})()}querySummaryStatistics(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.querySummaryStatistics",{query:t.toJSON(),params:e},r)})()}queryUniqueValues(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryUniqueValues",{query:t.toJSON(),params:e},r)})()}queryClassBreaks(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryClassBreaks",{query:t.toJSON(),params:e},r)})()}queryHistogram(t,e,r){var i=this;return(0,o.Z)(function*(){return yield i._startupResolver.promise,i._connection.invoke("controller.queryHistogram",{query:t.toJSON(),params:e},r)})()}queryFeatures(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatures",t.toJSON(),e)})()}queryVisibleFeatures(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryVisibleFeatures",t.toJSON(),e)})()}queryObjectIds(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryObjectIds",t.toJSON(),e)})()}queryFeatureCount(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryFeatureCount",t.toJSON(),e)})()}queryExtent(t,e){var r=this;return(0,o.Z)(function*(){return r._connection.invoke("controller.queryExtent",t.toJSON(),e)})()}queryLatestObservations(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,r._connection.invoke("controller.queryLatestObservations",t.toJSON(),e)})()}queryStatistics(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.queryStatistics",t)})()}getObjectId(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getObjectId",t)})()}getDisplayId(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getDisplayId",t)})()}getFeatures(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.getFeatures",t)})()}getAggregates(){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregates")})()}getAggregateValueRanges(){var t=this;return(0,o.Z)(function*(){return yield t._startupResolver.promise,t._connection.invoke("controller.getAggregateValueRanges")})()}mapValidDisplayIds(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,e._connection.invoke("controller.mapValidDisplayIds",t)})()}onEdits(t){var e=this;return(0,o.Z)(function*(){return yield e._startupResolver.promise,(0,v.R8)(e._connection.invoke("controller.onEdits",t))})()}enableEvent(t,e){var r=this;return(0,o.Z)(function*(){return yield r._startupResolver.promise,(0,v.R8)(r._connection.invoke("controller.enableEvent",{name:t,value:e}))})()}pauseStream(){return(0,v.R8)(this._connection.invoke("controller.pauseStream"))}resumeStream(){return(0,v.R8)(this._connection.invoke("controller.resumeStream"))}_startWorker(t){var e=this;return(0,o.Z)(function*(){try{e._connection=yield(0,A.bA)("Pipeline",{client:e.client,strategy:"dedicated",signal:t})}catch(r){(0,v.H9)(r)}})()}};(0,c._)([(0,u.Cb)()],X.prototype,"isReady",void 0),(0,c._)([(0,u.Cb)()],X.prototype,"client",void 0),(0,c._)([(0,u.Cb)()],X.prototype,"tileRenderer",null),X=(0,c._)([(0,F.j)("esri.views.2d.layers.support.FeatureLayerProxy")],X);const Oe=X;var Ie=n(43930),Se=n(84378),_e=n(58098);class xe{constructor(e){this._tiles=new Map,this.buffer=0,this.acquireTile=e.acquireTile,this.releaseTile=e.releaseTile,this.tileInfoView=e.tileInfoView,this.buffer=e.buffer}destroy(){}clear(){this._tiles.forEach(e=>this._releaseTile(e))}tileKeys(){const e=[];return this._tiles.forEach((r,i)=>e.push(i)),e}update(e){const r=this.tileInfoView.getTileCoverage(e.state,this.buffer,"closest"),{spans:i,lodInfo:s}=r,{level:l}=s,d=[],y=[],p=new Set,f=new Set;for(const{row:h,colFrom:C,colTo:w}of i)for(let S=C;S<=w;S++){const B=_e.Z.getId(l,h,s.normalizeCol(S),s.getWorldForColumn(S)),L=this._getOrAcquireTile(d,B);p.add(B),L.isReady?L.visible=!0:f.add(L.key)}return f.forEach(h=>this._addPlaceholders(p,h)),this._tiles.forEach(h=>{p.has(h.key.id)||(y.push(h.key.id),this._releaseTile(h))}),Se.Z.pool.release(r),{hasMissingTiles:f.size>0,added:d,removed:y}}_getOrAcquireTile(e,r){if(!this._tiles.has(r)){const i=this.acquireTile(new _e.Z(r));e.push(r),this._tiles.set(r,i),i.visible=!1}return this._tiles.get(r)}_getTile(e){return this._tiles.get(e)}_releaseTile(e){this._tiles.delete(e.key.id),this.releaseTile(e)}_addPlaceholders(e,r){const i=this._addPlaceholderChildren(e,r);Math.abs(1-i)<1e-6||this._addPlaceholderParent(e,r)||(this._getTile(r.id).visible=!0)}_addPlaceholderChildren(e,r){let i=0;return this._tiles.forEach(s=>{i+=this._addPlaceholderChild(e,s,r)}),i}_addPlaceholderChild(e,r,i){return r.key.level<=i.level||!r.hasData||!i.contains(r.key)?0:(r.visible=!0,e.add(r.key.id),1/(1<<2*(r.key.level-i.level)))}_addPlaceholderParent(e,r){let i=r.getParentKey(),s=0,l=null;for(;(0,a.pC)(i);){if(e.has(i.id))return!0;const d=this._getTile(i.id);if(null!=d&&d.isReady)return d.visible=!0,e.add(d.key.id),!0;(null==d?void 0:d.hasData)&&d.patchCount>s&&(s=d.patchCount,l=d),i=i.getParentKey()}return!!l&&(l.visible=!0,e.add(l.key.id),!0)}}var me=n(55538),Pe=n(13812),we=n(2319),P=n(36630),Ee=n(59990),Te=n(46679),de=n(10023);const ue=z.Z.getLogger("esri.views.layers.FeatureLayerView"),Ue=t=>{let e=class extends t{constructor(...r){super(...r),this._updatingRequiredFieldsPromise=null,this.filter=null,this.timeExtent=null,this.layer=null,this.requiredFields=[],this.view=null}initialize(){this.handles.add([(0,m.YP)(()=>{var i;const r=this.layer;return[null==(i=null==r?void 0:r.elevationInfo)?void 0:i.featureExpressionInfo,null==r?void 0:r.displayField,null==r?void 0:r.timeInfo,r&&"renderer"in r&&r.renderer,r&&"labelingInfo"in r&&r.labelingInfo,r&&"floorInfo"in r&&r.floorInfo,this.filter,this.featureEffect,this.timeExtent]},()=>this._handleRequiredFieldsChange(),m.tX),(0,m.on)(()=>{var r;return null==(r=this.view)?void 0:r.floors},"change",()=>this._handleRequiredFieldsChange()),(0,m.on)(()=>{const r=this.layer;return r&&"sublayers"in r&&r.sublayers},"change",()=>this._handleRequiredFieldsChange())])}get availableFields(){const{layer:r,layer:{fieldsIndex:i},requiredFields:s}=this;return(0,P.Q0)(i,"outFields"in r&&r.outFields?[...(0,P.Lk)(i,r.outFields),...s]:s)}set effect(r){(0,me.Mr)(ue,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect=r}get effect(){return(0,me.Mr)(ue,"effect",{replacement:"featureEffect",version:"4.22"}),this.featureEffect}get featureEffect(){return this.layer&&"featureEffect"in this.layer?this.layer.featureEffect:null}set featureEffect(r){void 0!==r?this._override("featureEffect",r):this._clearOverride("featureEffect")}get maximumNumberOfFeatures(){return 0}set maximumNumberOfFeatures(r){ue.error("#maximumNumberOfFeatures=","Setting maximum number of features is not supported")}get maximumNumberOfFeaturesExceeded(){return!1}highlight(r){throw new Error("missing implementation")}createQuery(){const r={outFields:["*"],returnGeometry:!0,outSpatialReference:this.view.spatialReference},i=(0,a.pC)(this.filter)?this.filter.createQuery(r):new Y.Z(r);if("feature"===this.layer.type){const s=(0,Ee.c)(this);(0,a.pC)(s)&&(i.where=i.where?`(${i.where}) AND (${s})`:s)}return(0,a.pC)(this.timeExtent)&&(i.timeExtent=(0,a.pC)(i.timeExtent)?i.timeExtent.intersection(this.timeExtent):this.timeExtent.clone()),i}queryFeatures(r,i){throw new Error("missing implementation")}queryObjectIds(r,i){throw new Error("missing implementation")}queryFeatureCount(r,i){throw new Error("missing implementation")}queryExtent(r,i){throw new Error("missing implementation")}fetchPopupFeatures(r,i){var s=this;return(0,o.Z)(function*(){const l=s.validateFetchPopupFeatures(i);if(l)throw l;return s.fetchClientPopupFeatures(i)})()}_loadArcadeModules(r){if(r.get("expressionInfos.length")||Array.isArray(r.content)&&r.content.some(i=>"expression"===i.type))return(0,Te.LC)()}_handleRequiredFieldsChange(){const r=this._updateRequiredFields();this._set("_updatingRequiredFieldsPromise",r),r.then(()=>{this._updatingRequiredFieldsPromise===r&&this._set("_updatingRequiredFieldsPromise",null)})}_updateRequiredFields(){var r=this;return(0,o.Z)(function*(){if(!r.layer||!r.view)return;const i="3d"===r.view.type,{layer:s,layer:{fieldsIndex:l,objectIdField:d}}=r,y="renderer"in s&&s.renderer,p="orderBy"in s&&s.orderBy,f=s.featureReduction,h=new Set,C=yield(0,v.as)([y?y.collectRequiredFields(h,l):null,(0,P.Mu)(h,s),i?(0,P.vl)(h,s):null,(0,a.pC)(r.filter)?(0,P.Ll)(h,s,r.filter):null,(0,a.pC)(r.featureEffect)?(0,P.Ll)(h,s,r.featureEffect.filter):null,f?(0,P.ZV)(h,s,f):null,p?(0,P.Qj)(h,s,p):null]);if(s.timeInfo&&r.timeExtent&&(0,P.gd)(h,s.fieldsIndex,[s.timeInfo.startField,s.timeInfo.endField]),"feature"===s.type&&s.floorInfo&&(0,P.gd)(h,s.fieldsIndex,[s.floorInfo.floorField]),"subtype-group"===s.type){(0,P.AB)(h,l,s.subtypeField);const S=s.sublayers.map(B=>{var L;return Promise.all([null==(L=B.renderer)?void 0:L.collectRequiredFields(h,l),(0,P.Mu)(h,B)])});yield(0,v.as)(S)}for(const S of C)S.error&&ue.error(S.error);(0,P.AB)(h,l,d),i&&"displayField"in s&&s.displayField&&(0,P.AB)(h,l,s.displayField);const w=Array.from(h).sort();r._set("requiredFields",w)})()}validateFetchPopupFeatures(r){if((0,a.Wi)(r))return null;for(const i of r.clientGraphics){const s=i.layer;if("popupEnabled"in s&&!s.popupEnabled)return new T.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s});if(i.isAggregate){if(!(s.featureReduction&&"popupTemplate"in s.featureReduction&&s.featureReduction.popupEnabled&&s.featureReduction.popupTemplate))return new T.Z("featurelayerview:fetchPopupFeatures","Popups are disabled",{layer:s})}else if("popupTemplate"in s&&!(0,de.V)(s,r))return new T.Z("featurelayerview:fetchPopupFeatures","Layer does not define a popup template",{layer:s})}}fetchClientPopupFeatures(r){var i=this;return(0,o.Z)(function*(){const s=(0,a.pC)(r)?r.clientGraphics:null;if(!s||0===s.length)return[];const l=new Array(s.length),d=new Map,y=yield i.createPopupQuery(r);for(let p=0;p<s.length;p++){const f=s[p];if(f.isAggregate){l[p]=f;continue}const{layer:h}=f;if(!("popupEnabled"in h))continue;const C=(0,P.Lk)(i.layer.fieldsIndex,y.outFields),w=(0,de.V)(h,r);if((0,a.Wi)(w))continue;const S=yield i._loadArcadeModules(w);S&&S.arcadeUtils.hasGeometryOperations(w)||!(0,P.R9)(C,f)?d.set(f.getObjectId(),p):l[p]=f}if("stream"===i.layer.type||0===d.size)return l.filter(Boolean);y.objectIds=Array.from(d.keys());try{const p=yield i.layer.queryFeatures(y);for(const f of p.features)l[d.get(f.getObjectId())]=f}catch(p){}return l.filter(Boolean)})()}createPopupQuery(r){var i=this;return(0,o.Z)(function*(){const s=i.layer.createQuery(),l=new Set;let d=!1;const y=(0,a.pC)(r)&&r.clientGraphics?r.clientGraphics.map(p=>p.layer):[i.layer];for(const p of y){if(!("popupEnabled"in p))continue;const f=(0,de.V)(p,r);if((0,a.Wi)(f))continue;const h=yield i._loadArcadeModules(f),C=h&&h.arcadeUtils.hasGeometryOperations(f);d=!("point"!==i.layer.geometryType&&!C);const w=yield(0,de.e)(i.layer,f);for(const S of w)l.add(S)}if(s.returnGeometry=d,s.returnZ=d,s.returnM=d,s.outFields=Array.from(l),s.outSpatialReference=i.view.spatialReference,"feature"===i.layer.type){const p=(0,Ee.c)(i);(0,a.pC)(p)&&(s.where=s.where?`(${s.where}) AND (${p})`:p)}return s})()}canResume(){return!(!super.canResume()||(0,a.pC)(this.timeExtent)&&this.timeExtent.isEmpty)}};return(0,c._)([(0,u.Cb)()],e.prototype,"_updatingRequiredFieldsPromise",void 0),(0,c._)([(0,u.Cb)({readOnly:!0})],e.prototype,"availableFields",null),(0,c._)([(0,u.Cb)()],e.prototype,"effect",null),(0,c._)([(0,u.Cb)({type:we.Z})],e.prototype,"featureEffect",null),(0,c._)([(0,u.Cb)({type:se.Z})],e.prototype,"filter",void 0),(0,c._)([(0,u.Cb)(Pe.qG)],e.prototype,"timeExtent",void 0),(0,c._)([(0,u.Cb)()],e.prototype,"layer",void 0),(0,c._)([(0,u.Cb)({type:Number})],e.prototype,"maximumNumberOfFeatures",null),(0,c._)([(0,u.Cb)({readOnly:!0,type:Boolean})],e.prototype,"maximumNumberOfFeaturesExceeded",null),(0,c._)([(0,u.Cb)({readOnly:!0})],e.prototype,"requiredFields",void 0),(0,c._)([(0,u.Cb)()],e.prototype,"suspended",void 0),(0,c._)([(0,u.Cb)()],e.prototype,"view",void 0),e=(0,c._)([(0,F.j)("esri.views.layers.FeatureLayerView")],e),e};var Ve=n(45611),Ze=n(94421),je=n(31637),Ae=n(2004);function Ce(t){return t&&"openPorts"in t}const re=z.Z.getLogger("esri.views.2d.layers.FeatureLayerView2D");let M=class extends(Ue((0,Ze.Z)((0,K.y)(Ve.Z)))){constructor(){var t;super(...arguments),t=this,this._pipelineIsUpdating=!0,this._commandsQueue=new oe({process:e=>{switch(e.type){case"processed-edit":return this._doEdit(e);case"refresh":return this._doRefresh(e.dataChanged);case"update":return this._doUpdate()}}}),this._visibilityOverrides=new Set,this._highlightIds=new Map,this._updateHighlight=(0,v.Ds)((0,o.Z)(function*(){return t._proxy.setHighlight(Array.from(t._highlightIds.keys()))})),this._uploadsLocked=!1,this._needsClusterSizeUpdate=!1,this.featureEffectView=new ye,this._lastDefinitionExpression=null}destroy(){var t;(0,a.yw)(this._updateClusterSizeTask,e=>e.remove()),null==(t=this._proxy)||t.destroy(),this._commandsQueue.destroy()}initialize(){this.addResolvingPromise(Promise.all([this._initProxy(),this._initServiceOptions()])),this.handles.add([this.on("valueRangesChanged",t=>{this._set("_aggregateValueRanges",t.valueRanges)}),(0,m.YP)(()=>this.featureEffect,t=>{this.featureEffectView.featureEffect=t},{initial:!0,sync:!0})])}_initProxy(){var t=this;return(0,o.Z)(function*(){const e=t.layer;if("isTable"in e&&e.isTable)throw new T.Z("featurelayerview:table-not-supported","table feature layer can't be displayed",{layer:t.layer});if(!("feature"!==e.type&&"subtype-group"!==e.type||"capabilities"in e&&e.capabilities.operations.supportsQuery))throw new T.Z("featurelayerview:query-not-supported","layer view requires a layer with query capability",{layer:e});t._proxy&&t._proxy.destroy();const s=t._createClientOptions();return t._set("_proxy",new Oe({client:s})),t._proxy.when()})()}_initServiceOptions(){var t=this;return(0,o.Z)(function*(){return t._set("_serviceOptions",yield t._createServiceOptions()),t._serviceOptions})()}get orderByFields(){return"stream"!==this._serviceOptions.type&&this._serviceOptions.orderByFields}get labelsVisible(){return!this.suspended&&("subtype-group"===this.layer.type?this.layer.sublayers.items:[this.layer]).some(e=>e.labelingInfo&&e.labelsVisible)}get queryMode(){return this._serviceOptions.type}get renderingConfigHash(){if(!this.layer)return null;const t=this.availableFields,e=this.layer,r=this.view.floors,{definitionExpression:i}=e,s="subtype-group"!==this.layer.type&&this.layer.labelsVisible&&this.layer.labelingInfo,l="renderer"in e&&e.renderer,d="feature"===e.type?e.gdbVersion:void 0,y="feature"===e.type&&e.historicMoment?e.historicMoment.getTime():void 0,{timeExtent:p}=this,f="customParameters"in e?JSON.stringify(e.customParameters):void 0,h="apiKey"in e?e.apiKey:void 0,C="stream"===e.type?`${JSON.stringify(e.geometryDefinition)}${e.definitionExpression}`:null,w=JSON.stringify(this.clips),S=e.featureReduction&&e.featureReduction.toJSON(),B="orderBy"in this.layer&&JSON.stringify(this.layer.orderBy),L="sublayers"in this.layer&&this.layer.sublayers.items.reduce((k,he)=>k+`${he.visible?1:0}.${JSON.stringify(he.renderer)}.${he.labelsVisible}\n.${JSON.stringify(he.labelingInfo)}`,"");return JSON.stringify({orderBy:B,sublayerHash:L,subtypeCode:"subtypeCode"in this.layer&&this.layer.subtypeCode,filterHash:(0,a.pC)(this.filter)&&this.filter.toJSON(),effectHash:(0,a.pC)(this.featureEffect)&&this.featureEffect.toJSON(),streamFilter:C,gdbVersion:d,definitionExpression:i,historicMoment:y,availableFields:t,renderer:l,labelingInfo:s,timeExtent:p,floors:r,clipsHash:w,featureReduction:S,customParameters:f,apiKey:h})}highlight(t){let e;return t instanceof Z.Z?e=[t.getObjectId()]:"number"==typeof t||"string"==typeof t?e=[t]:Array.isArray(t)&&t.length>0?e="number"==typeof t[0]||"string"==typeof t[0]?t:t.map(r=>null==r?void 0:r.getObjectId()):N.Z.isCollection(t)&&t.length>0&&(e=t.map(r=>null==r?void 0:r.getObjectId()).toArray()),e=null==e?void 0:e.filter(r=>null!=r),e&&e.length?(this._addHighlight(e),{remove:()=>this._removeHighlight(e)}):{remove:()=>{}}}hasHighlight(){return!!this._highlightIds.size}hitTest(t,e){var r=this;return(0,o.Z)(function*(){if(!r.tileRenderer)return null;const i=yield r.tileRenderer.hitTest(e);if(0===i.length)return null;const{features:s,aggregates:l}=yield r._proxy.getFeatures(i);return[...l.map(d=>r._createGraphicHit(t,D.fromJSON(d))),...s.map(d=>r._createGraphicHit(t,Z.Z.fromJSON(d)))]})()}queryAggregates(){var t=this;return(0,o.Z)(function*(){return(yield t._proxy.getAggregates()).map(e=>D.fromJSON(e))})()}queryStatistics(){return this._proxy.queryStatistics()}querySummaryStatistics(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.querySummaryStatistics(i._cleanUpQuery(t),s,r)})()}queryUniqueValues(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.queryUniqueValues(i._cleanUpQuery(t),s,r)})()}queryClassBreaks(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.queryClassBreaks(i._cleanUpQuery(t),s,r)})()}queryHistogram(t,e,r){var i=this;return(0,o.Z)(function*(){const s=$(q({},e),{scale:i.view.scale});return i._proxy.queryHistogram(i._cleanUpQuery(t),s,r)})()}queryFeatures(t,e){return this.queryFeaturesJSON(t,e).then(r=>{const i=ne.default.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryVisibleFeatures(t,e){return this._proxy.queryVisibleFeatures(this._cleanUpQuery(t),e).then(r=>{const i=ne.default.fromJSON(r);return i.features.forEach(s=>this._setLayersForFeature(s)),i})}queryFeaturesJSON(t,e){return this._proxy.queryFeatures(this._cleanUpQuery(t),e)}queryObjectIds(t,e){return this._proxy.queryObjectIds(this._cleanUpQuery(t),e)}queryFeatureCount(t,e){return this._proxy.queryFeatureCount(this._cleanUpQuery(t),e)}queryExtent(t,e){return this._proxy.queryExtent(this._cleanUpQuery(t),e).then(r=>({count:r.count,extent:Ae.Z.fromJSON(r.extent)}))}setVisibility(t,e){e?this._visibilityOverrides.delete(t):this._visibilityOverrides.add(t),this._update()}update(t){if(!this._tileStrategy||!this.tileRenderer)return;const{hasMissingTiles:e,added:r,removed:i}=this._tileStrategy.update(t);(r.length||i.length)&&this._proxy.updateTiles({added:r,removed:i}),e&&this.requestUpdate(),this.notifyChange("updating")}attach(){this.view.timeline.record(`${this.layer.title} (FeatureLayer) Attach`),this._tileStrategy=new xe({acquireTile:t=>this._acquireTile(t),releaseTile:t=>this._releaseTile(t),tileInfoView:this.view.featuresTilingScheme,buffer:0}),this.handles.add((0,m.YP)(()=>this.renderingConfigHash,()=>this._update(),m.nn),"attach"),"stream"!==this.layer.type&&this.handles.add(this.layer.on("edits",t=>this._edit(t)),"attach")}detach(){var t;this._commandsQueue.clear(),null==(t=this._proxy)||t.stop(),this.container.removeAllChildren(),this.handles.remove("attach"),this.tileRenderer&&(this.tileRenderer.uninstall(this.container),this.tileRenderer=null),this._tileStrategy&&(this._tileStrategy.destroy(),this._tileStrategy=null),this._tileRendererHash=null}moveStart(){this.requestUpdate()}viewChange(){this.requestUpdate()}moveEnd(){this.requestUpdate()}isUpdating(){var y;const t="renderer"in this.layer&&null!=this.layer.renderer,e=this._commandsQueue.updating,r=null!=this._updatingRequiredFieldsPromise,i=!this._proxy||!this._proxy.isReady,s=this._pipelineIsUpdating,l=null==this.tileRenderer||(null==(y=this.tileRenderer)?void 0:y.updating),d=t&&(e||r||i||s||l);return(0,g.Z)("esri-2d-log-updating")&&console.log(`Updating FLV2D: ${d}\n  -> hasRenderer ${t}\n  -> hasPendingCommand ${e}\n  -> updatingRequiredFields ${r}\n  -> updatingProxy ${i}\n  -> updatingPipeline ${s}\n  -> updatingTileRenderer ${l}\n`),d}_createClientOptions(){return{setUpdating:t=>{this._set("_pipelineIsUpdating",t)},emitEvent:t=>{this.emit(t.name,t.event)}}}_detectQueryMode(t){var e=this;return(0,o.Z)(function*(){var d;const i="editingInfo"in e.layer&&(null==(d=e.layer.editingInfo)?void 0:d.lastEditDate);if("path"in t&&("feature"===e.layer.type||"subtype-group"===e.layer.type)&&"point"===e.layer.geometryType&&e.layer.capabilities.query.supportsPagination&&!e.layer.capabilities.operations.supportsEditing&&(i||!e.layer.refreshInterval)&&(0,g.Z)("featurelayer-snapshot-enabled"))try{const y=yield e.layer.queryFeatureCount();if(y<=(0,g.Z)("featurelayer-snapshot-point-min-threshold"))return{mode:"snapshot",featureCount:y};const p=(0,g.Z)("featurelayer-snapshot-point-max-threshold"),f=(0,g.Z)("featurelayer-snapshot-point-coverage"),h=e.view.extent,C=(0,a.Wg)(e.layer.fullExtent),w=null==C?void 0:C.clone().intersection(h),S=(0,a.pC)(w)?w.width*w.height:0,B=(null==C?void 0:C.width)*(null==C?void 0:C.height),L=0===B?0:S/B;if(y<=p&&L>=f)return{mode:"snapshot",featureCount:y}}catch(y){re.warn("mapview-feature-layer","Encountered an error when querying for featureCount",{error:y})}return{mode:"on-demand"}})()}_createServiceOptions(){var t=this;return(0,o.Z)(function*(){var ce;const e=t.layer;if("stream"===e.type)return null;const{capabilities:r,objectIdField:i}=e,s=e.fields.map(k=>k.toJSON()),l=(0,a.pC)(e.fullExtent)&&e.fullExtent.toJSON(),d=(0,Ie.oq)(e.geometryType),y=e.timeInfo&&e.timeInfo.toJSON()||null,p=e.spatialReference?e.spatialReference.toJSON():null,f="feature"===e.type?e.globalIdField:null;let h;"ogc-feature"===e.type?h=e.source.getFeatureDefinition():Ce(e.source)?h=yield e.source.openPorts():e.parsedUrl&&(h=(0,I.d9)(e.parsedUrl),"dynamicDataSource"in e&&e.dynamicDataSource&&(h.query={layer:JSON.stringify({source:e.dynamicDataSource})}));const C="datesInUnknownTimezone"in t.layer&&t.layer.datesInUnknownTimezone,w=null!=(ce="subtypeField"in t.layer&&t.layer.subtypeField)?ce:null,{mode:S,featureCount:B}=yield t._detectQueryMode(h);let L=t.layer.objectIdField;if("feature"===t.layer.type&&(0,a.pC)(t.layer.orderBy)&&t.layer.orderBy.length){const k=!t.layer.orderBy[0].valueExpression&&t.layer.orderBy[0].field;k&&(L=k)}return{type:S,timeReferenceUnknownClient:C,subtypeField:w,featureCount:B,globalIdField:f,maxRecordCount:r.query.maxRecordCount,tileMaxRecordCount:r.query.tileMaxRecordCount,capabilities:r,fields:s,fullExtent:l,geometryType:d,objectIdField:i,source:h,timeInfo:y,spatialReference:p,orderByFields:L}})()}_createMemoryServiceOptions(t){var e=this;return(0,o.Z)(function*(){const r=yield t.openPorts();return $(q({},e._createServiceOptions()),{type:"memory",source:r})})()}_cleanUpQuery(t){const e=Y.Z.from(t)||this.createQuery();return e.outSpatialReference||(e.outSpatialReference=this.view.spatialReference),e}_update(){var t=this;return(0,o.Z)(function*(){return t._commandsQueue.push({type:"update"})})()}_edit(t){var e=this;return(0,o.Z)(function*(){return e.suspended?void e._clearTiles():e._validateEdit(t)?e._commandsQueue.push({type:"edit",edits:t}):void 0})()}doRefresh(t){var e=this;return(0,o.Z)(function*(){if(e._tileStrategy.tileKeys().length)return e.suspended&&t?void e._clearTiles():e._commandsQueue.push({type:"refresh",dataChanged:t})})()}_clearTiles(){this._tileStrategy.tileKeys().length&&(this._proxy.updateTiles({added:[],removed:this._tileStrategy.tileKeys()}),this._tileStrategy.clear(),this.requestUpdate(),this._commandsQueue.clear(),this._update())}_validateEdit(t){const e="globalIdField"in this.layer&&this.layer.globalIdField,r=t.deletedFeatures.some(s=>-1===s.objectId||!s.objectId),i=e&&this.availableFields.includes(e);return r&&!i?(re.error(new T.Z("mapview-apply-edits",`Editing the specified service requires the layer's globalIdField, ${e} to be included the layer's outFields for updates to be reflected on the map`)),null):t}_doUpdate(){var t=this;return(0,o.Z)(function*(){try{if(t.destroyed||!t._hasRequiredSupport(t.layer)||!t._tileStrategy)return;const{featureEffectView:e,filter:r}=t;yield t._updateRequiredFields();const{renderer:i}=t._getEffectiveRenderer();t._set("_effectiveRenderer",i);const s=t._createSchemaConfig(),l=t._createConfiguration(s,r,e.filter),d=t._lastDefinitionExpression!==l.schema.source.definitionExpression;t._lastDefinitionExpression=l.schema.source.definitionExpression;const y=l.schema.tileRenderer,p=t._createTileRendererHash(y);if("snapshot"===t._serviceOptions.type&&(l.schema.source.featureCount=t._serviceOptions.featureCount),p!==t._tileRendererHash){yield t._initTileRenderer(y,i);const f=t.layer,h="stream"===f.type?yield t._initServiceOptions():t._serviceOptions;t.tileRenderer.onConfigUpdate(i),"stream"!==f.type&&Ce(f.source)&&(h.source=yield f.source.openPorts());const C={added:t._tileStrategy.tileKeys(),removed:[]};yield t._proxy.startup(t.view.featuresTilingScheme,l,h,C),t.hasHighlight()&&(yield t._proxy.setHighlight(Array.from(t._highlightIds.keys()))),yield t._onceTilesUpdated(),t.tileRenderer.onConfigUpdate(i)}else{"snapshot"===t._serviceOptions.type&&d&&(l.schema.source.featureCount=yield t.layer.queryFeatureCount());const f=yield t._proxy.update(l);(f.mesh||f.targets.aggregate)&&t._lockGPUUploads();try{yield t._proxy.applyUpdate(f)}catch(h){(0,v.D_)(h)||re.error(h)}(f.mesh||f.targets.aggregate)&&t._unlockGPUUploads(),t.tileRenderer.onConfigUpdate(i),t._updateClusterSizeVariable(),t._forceAttributeTextureUpload()}t._tileRendererHash=p,t.tileRenderer.invalidateLabels(),t.requestUpdate()}catch(e){}})()}_doEdit(t){var e=this;return(0,o.Z)(function*(){try{yield e._proxy.onEdits(t)}catch(r){(0,v.D_)(r)}})()}_doRefresh(t){var e=this;return(0,o.Z)(function*(){var r;e._lockGPUUploads();try{yield e._proxy.refresh(t)}catch(i){(0,v.D_)(i)}e._unlockGPUUploads(),null!=(r=e.layer)&&r.featureReduction&&e._updateClusterSizeVariable()})()}_updateClusterSizeVariable(){this._needsClusterSizeUpdate&&(this.tileRenderer.onConfigUpdate(this._effectiveRenderer),this._needsClusterSizeUpdate=!1)}_createUpdateClusterSizeTask(t,e){return(0,m.YP)(()=>this._aggregateValueRanges,r=>{this._updateClusterEffectiveRendererSizeVariable(t,e,r),this._needsClusterSizeUpdate=!0,this._uploadsLocked||this._updateClusterSizeVariable()})}_updateClusterEffectiveRendererSizeVariable(t,e,r){var i=this;return(0,o.Z)(function*(){if(t.dynamicClusterSize&&"visualVariables"in t&&t.visualVariables){const s=(0,G.os)(t.visualVariables);if((0,a.pC)(s)&&"cluster_count"===s.field){const l=t.visualVariables.indexOf(s);t.visualVariables[l]=(0,G.aV)(e,r);const d=t.clone();d.dynamicClusterSize=!0,i._set("_effectiveRenderer",d)}}})()}_getEffectiveRenderer(){var r;const t="renderer"in this.layer&&this.layer.renderer,e=this.layer.featureReduction;if((0,a.pC)(this._updateClusterSizeTask)&&(this._updateClusterSizeTask.remove(),this._updateClusterSizeTask=null),e&&"renderer"in e&&e.renderer){const i=[];for(const s of null!=(r=e.fields)?r:[])(0,G.OQ)(i,s);return{renderer:e.renderer,aggregateFields:i,featureReduction:e}}if(e&&"cluster"===e.type&&(0,G.yR)(t)){const i=e,s=[],l=(0,G.S1)(s,t,i,this._aggregateValueRanges);return(0,a.yw)(this._updateClusterSizeTask,d=>d.remove()),this._updateClusterSizeTask=this._createUpdateClusterSizeTask(l,i),{renderer:l,aggregateFields:s,featureReduction:e}}return{renderer:t,aggregateFields:[],featureReduction:null}}_acquireTile(t){const e=this.tileRenderer.acquireTile(t);return e.once("attach",()=>{this.requestUpdate()}),e}_releaseTile(t){this.tileRenderer.releaseTile(t)}_initTileRenderer(t,e){var r=this;return(0,o.Z)(function*(){const i=yield function Q(t,e){return ee.apply(this,arguments)}(t,{layerView:r,tileInfoView:r.view.featuresTilingScheme,layer:r.layer});return r.tileRenderer&&(r._tileStrategy.clear(),r.tileRenderer.uninstall(r.container),r.tileRenderer.destroy(),r.tileRenderer=null),r.destroyed?null:(r._proxy.tileRenderer=i,r._set("tileRenderer",i),r.tileRenderer.install(r.container),r.tileRenderer.onConfigUpdate(e),r.requestUpdate(),r.tileRenderer)})()}_createTileRendererHash(t){return`${t.type}`}get hasFilter(){return!!(this.filter||"floorInfo"in this.layer&&this.layer.floorInfo&&this.view.floors&&this.view.floors.length||this._visibilityOverrides.size||this.timeExtent)}_injectOverrides(t){const e=(0,a.pC)(t)?t.timeExtent:null,r=(0,a.pC)(this.timeExtent)&&(0,a.pC)(e)?this.timeExtent.intersection(e):this.timeExtent||e;let i=null;const s="floorInfo"in this.layer&&this.layer.floorInfo;if(s){const d=(0,a.pC)(t)&&t.where;i=this._addFloorFilterClause(d)}if(!this._visibilityOverrides.size&&!r&&!s)return(0,a.pC)(t)?t.toJSON():null;(t=(0,a.pC)(t)&&t.clone()||new se.Z).timeExtent=r,i&&(t.where=i);const l=t.toJSON();return l.hiddenIds=Array.from(this._visibilityOverrides),l}_addFloorFilterClause(t){var i;const e=this.layer;let r=t||"";if("floorInfo"in e&&e.floorInfo){let s=this.view.floors;if(!s||!s.length)return r;null!=(i=e.floorInfo.viewAllLevelIds)&&i.length&&(s=e.floorInfo.viewAllLevelIds);const l=s.filter(p=>""!==p).map(p=>"'"+p+"'");l.push("''");const d=e.floorInfo.floorField;let y="("+d+" IN ({ids}) OR "+d+" IS NULL)";if(y=y.replace("{ids}",l.join(", ")),(0,a.pC)(r)&&r.includes(d)){let p=new RegExp("AND \\("+d+".*NULL\\)","g");r=r.replace(p,""),p=new RegExp("\\("+d+".*NULL\\)","g"),r=r.replace(p,""),r=r.replace(/\s+/g," ").trim()}r=""!==r?"("+r+") AND "+y:y}return""!==r?r:null}_createConfiguration(t,e,r){const i="feature"===this.layer.type&&this.layer.historicMoment?this.layer.historicMoment.getTime():void 0,s="feature"===this.layer.type?this.layer.gdbVersion:void 0,l=new Array(fe.m4),d=this._injectOverrides(e);l[0]=d,l[1]=(0,a.pC)(r)?r.toJSON():null;const y=(0,ge.Ew)(t);if((0,a.Wi)(y))return null;const p=(0,je.hc)("2d");return{availableFields:this.availableFields,gdbVersion:s,historicMoment:i,devicePixelRatio:window.devicePixelRatio||1,filters:l,schema:y,supportsTextureFloat:p.supportsTextureFloat,maxTextureSize:p.maxTextureSize}}_hasRequiredSupport(t){return!("renderer"in t)||(0,te.TT)(t.renderer)}_onceTilesUpdated(){return this.requestUpdate(),(0,m.N1)(()=>!this._pipelineIsUpdating)}_lockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!0,this.tileRenderer.lockGPUUploads())}_unlockGPUUploads(){this.tileRenderer&&(this._uploadsLocked=!1,this.tileRenderer.unlockGPUUploads())}_forceAttributeTextureUpload(){this.tileRenderer&&this.tileRenderer.forceAttributeTextureUpload()}_createSchemaConfig(){return{renderer:"renderer"in this.layer&&this.layer.renderer,spatialReference:this.layer.spatialReference,timeExtent:this.layer.timeExtent,definitionExpression:this.layer.definitionExpression,featureReduction:this.layer.featureReduction,fields:this.layer.fields,geometryType:this.layer.geometryType,historicMoment:"feature"===this.layer.type?this.layer.historicMoment:null,labelsVisible:"labelsVisible"in this.layer&&this.layer.labelsVisible,labelingInfo:"labelingInfo"in this.layer&&this.layer.labelingInfo,availableFields:this.availableFields,featureEffect:this.featureEffect,filter:this.filter,gdbVersion:"feature"===this.layer.type?this.layer.gdbVersion:null,pixelBuffer:0,orderBy:"orderBy"in this.layer&&this.layer.orderBy?this.layer.orderBy:null,customParameters:$(q({},"customParameters"in this.layer?this.layer.customParameters:void 0),{token:"apiKey"in this.layer?this.layer.apiKey:void 0}),subtypeCode:"subtypeCode"in this.layer?this.layer.subtypeCode:void 0,subtypeField:"subtypeField"in this.layer?this.layer.subtypeField:void 0}}_addHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e);this._highlightIds.set(e,r+1)}else this._highlightIds.set(e,1);this._updateHighlight().catch(e=>{(0,v.D_)(e)||re.error(e)})}_removeHighlight(t){for(const e of t)if(this._highlightIds.has(e)){const r=this._highlightIds.get(e)-1;0===r?this._highlightIds.delete(e):this._highlightIds.set(e,r)}this._updateHighlight().catch(e=>{(0,v.D_)(e)||re.error(e)})}_setLayersForFeature(t){const e=this.layer;t.layer=e,t.sourceLayer=e}_createGraphicHit(t,e){return this._setLayersForFeature(e),(0,a.pC)(e.geometry)&&(e.geometry.spatialReference=this.view.spatialReference),{type:"graphic",graphic:e,layer:this.layer,mapPoint:t}}};(0,c._)([(0,u.Cb)()],M.prototype,"_serviceOptions",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"_proxy",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"_pipelineIsUpdating",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"_effectiveRenderer",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"_aggregateValueRanges",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"_commandsQueue",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"featureEffectView",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"labelsVisible",null),(0,c._)([(0,u.Cb)({readOnly:!0})],M.prototype,"queryMode",null),(0,c._)([(0,u.Cb)()],M.prototype,"renderingConfigHash",null),(0,c._)([(0,u.Cb)()],M.prototype,"tileRenderer",void 0),(0,c._)([(0,u.Cb)()],M.prototype,"updating",void 0),M=(0,c._)([(0,F.j)("esri.views.2d.layers.FeatureLayerView2D")],M);const Me=M},37384:(V,R,n)=>{n.d(R,{y:()=>G});var o=n(17626),c=n(74333),Z=n(89726),u=n(26584),_=n(32917),g=n(77712),D=(n(85931),n(8314),n(90912),n(76898)),H=n(1011),N=n(86810);n(63290),n(82255);let z=class extends N.wq{};z=(0,o._)([(0,D.j)("esri.views.layers.support.ClipArea")],z);const a=z;var v;let m=v=class extends a{constructor(){super(...arguments),this.type="rect",this.left=null,this.right=null,this.top=null,this.bottom=null}clone(){return new v({left:this.left,right:this.right,top:this.top,bottom:this.bottom})}get version(){return(this._get("version")||0)+1}};(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],m.prototype,"left",void 0),(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],m.prototype,"right",void 0),(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],m.prototype,"top",void 0),(0,o._)([(0,g.Cb)({type:[Number,String],json:{write:!0}})],m.prototype,"bottom",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],m.prototype,"version",null),m=v=(0,o._)([(0,D.j)("esri.views.layers.support.ClipRect")],m);const ie=m;n(29132);var Y,U=n(21674),ye=n(91179),se=n(2004),ne=n(37118);const fe={base:U.Z,key:"type",typeMap:{extent:se.Z,polygon:ne.Z}};let K=Y=class extends a{constructor(){super(...arguments),this.type="geometry",this.geometry=null}get version(){return(this._get("version")||0)+1}clone(){return new Y({geometry:this.geometry.clone()})}};(0,o._)([(0,g.Cb)({types:fe,json:{read:ye.im,write:!0}})],K.prototype,"geometry",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],K.prototype,"version",null),K=Y=(0,o._)([(0,D.j)("esri.views.layers.support.Geometry")],K);const ge=K;let Q=class extends a{constructor(){super(...arguments),this.type="path",this.path=[]}get version(){return(this._get("version")||0)+1}};(0,o._)([(0,g.Cb)({type:[[[Number]]],json:{write:!0}})],Q.prototype,"path",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],Q.prototype,"version",null),Q=(0,o._)([(0,D.j)("esri.views.layers.support.Path")],Q);const te=c.Z.ofType({key:"type",base:a,typeMap:{rect:ie,path:Q,geometry:ge}}),G=ve=>{let x=class extends ve{constructor(){super(...arguments),this.attached=!1,this.clips=new te,this.lastUpdateId=-1,this.moving=!1,this.updateRequested=!1}initialize(){var W,J,oe,ae;const E=null==(J=null==(W=this.view)?void 0:W.spatialReferenceLocked)||J;(null==(oe=this.view)?void 0:oe.spatialReference)&&E&&!this.spatialReferenceSupported?this.addResolvingPromise(Promise.reject(new u.Z("layerview:spatial-reference-incompatible","The spatial reference of this layer does not meet the requirements of the view",{layer:this.layer}))):(this.container||(this.container=new H.W),this.container.fadeTransitionEnabled=!0,this.container.opacity=0,this.container.clips=this.clips,this.handles.add([(0,_.YP)(()=>this.suspended,A=>{this.container&&(this.container.visible=!A),this.view&&!A&&this.updateRequested&&this.view.requestUpdate()},_.tX),(0,_.YP)(()=>{var A,le;return null!=(le=null==(A=this.layer)?void 0:A.opacity)?le:1},A=>{this.container&&(this.container.opacity=A)},_.tX),(0,_.YP)(()=>this.layer&&"blendMode"in this.layer?this.layer.blendMode:"normal",A=>{this.container&&(this.container.blendMode=A)},_.tX),(0,_.YP)(()=>this.layer&&"effect"in this.layer?this.layer.effect:null,A=>{this.container&&(this.container.effect=A)},_.tX),(0,_.on)(()=>this.clips,"change",()=>{this.container&&(this.container.clips=this.clips)})]),null!=(ae=this.view)&&ae.whenLayerView?this.view.whenLayerView(this.layer).then(A=>{A===this&&this.processAttach()},()=>{}):this.when().then(()=>{this.processAttach()},()=>{}))}destroy(){this.processDetach(),this.updateRequested=!1}get spatialReferenceSupported(){var j;const E=null==(j=this.view)?void 0:j.spatialReference;return null==E||this.supportsSpatialReference(E)}get updating(){var E;return this.spatialReferenceSupported&&(!this.attached||!this.suspended&&(this.updateRequested||this.isUpdating())||!(null==(E=this.updatingHandles)||!E.updating))}get visibleAtCurrentScale(){return this.isVisibleAtScale(this.view.scale)}processAttach(){this.isResolved()&&!this.attached&&!this.destroyed&&this.spatialReferenceSupported&&(this.attach(),this.attached=!0,this.requestUpdate())}processDetach(){this.attached&&(this.attached=!1,this.detach(),this.updateRequested=!1)}isVisibleAtScale(E){const j=this.layer&&"effectiveScaleRange"in this.layer?this.layer.effectiveScaleRange:null;if(!j)return!0;const{minScale:W,maxScale:J}=j;return(0===W||E<=W)&&(0===J||E>=J)}requestUpdate(){this.destroyed||this.updateRequested||(this.updateRequested=!0,this.suspended||this.view.requestUpdate())}processUpdate(E){!this.isFulfilled()||this.isResolved()?(this._set("updateParameters",E),this.updateRequested&&!this.suspended&&(this.updateRequested=!1,this.update(E))):this.updateRequested=!1}hitTest(E,j){return Promise.resolve(null)}supportsSpatialReference(E){return!0}canResume(){return!!this.spatialReferenceSupported&&!!super.canResume()&&this.visibleAtCurrentScale}getSuspendInfo(){const E=super.getSuspendInfo(),j=!this.spatialReferenceSupported,W=this.visibleAtCurrentScale;return j&&(E.spatialReferenceNotSupported=j),W&&(E.outsideScaleRange=W),E}};return(0,o._)([(0,g.Cb)()],x.prototype,"attached",void 0),(0,o._)([(0,g.Cb)({type:te,set(E){const j=(0,Z.Z)(E,this._get("clips"),te);this._set("clips",j)}})],x.prototype,"clips",void 0),(0,o._)([(0,g.Cb)()],x.prototype,"container",void 0),(0,o._)([(0,g.Cb)()],x.prototype,"moving",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],x.prototype,"spatialReferenceSupported",null),(0,o._)([(0,g.Cb)({readOnly:!0})],x.prototype,"updateParameters",void 0),(0,o._)([(0,g.Cb)()],x.prototype,"updateRequested",void 0),(0,o._)([(0,g.Cb)()],x.prototype,"updating",null),(0,o._)([(0,g.Cb)()],x.prototype,"view",void 0),(0,o._)([(0,g.Cb)({readOnly:!0})],x.prototype,"visibleAtCurrentScale",null),x=(0,o._)([(0,D.j)("esri.views.2d.layers.LayerView2D")],x),x}},45611:(V,R,n)=>{n.d(R,{Z:()=>z});var o=n(17626),c=n(14517),Z=n(61885),u=n(80542),_=n(61996),g=n(63290),b=n(62208),F=n(60330),O=n(77712),T=(n(85931),n(8314),n(90912),n(76898));let I=class extends((0,u.p)((0,_.IG)((0,F.v)(Z.Z.EventedMixin(c.Z))))){constructor(a){super(a),this.layer=null,this.parent=null}initialize(){this.when().catch(a=>{if("layerview:create-error"!==a.name){const v=this.layer&&this.layer.id||"no id",m=this.layer&&this.layer.title||"no title";g.Z.getLogger(this.declaredClass).error("#resolve()",`Failed to resolve layer view (layer title: '${m}', id: '${v}')`,a)}})}get fullOpacity(){return(0,b.Pt)(this.get("layer.opacity"),1)*(0,b.Pt)(this.get("parent.fullOpacity"),1)}get suspended(){return!this.canResume()}get suspendInfo(){return this.getSuspendInfo()}get legendEnabled(){var a;return!this.suspended&&!0===(null==(a=this.layer)?void 0:a.legendEnabled)}get updating(){var a;return!!(null!=(a=this.updatingHandles)&&a.updating||this.isUpdating())}get updatingProgress(){return this.updating?0:1}get visible(){var a;return!0===(null==(a=this.layer)?void 0:a.visible)}set visible(a){void 0!==a?this._override("visible",a):this._clearOverride("visible")}canResume(){var a,v,m;return this.visible&&(null==(a=this.layer)?void 0:a.loaded)&&!(null!=(v=this.parent)&&v.suspended)&&(null==(m=this.view)?void 0:m.ready)||!1}getSuspendInfo(){const a=this.parent&&this.parent.suspended?this.parent.suspendInfo:{};return this.view&&this.view.ready||(a.viewNotReady=!0),this.layer&&this.layer.loaded||(a.layerNotLoaded=!0),this.visible||(a.layerInvisible=!0),a}isUpdating(){return!1}};(0,o._)([(0,O.Cb)()],I.prototype,"fullOpacity",null),(0,o._)([(0,O.Cb)()],I.prototype,"layer",void 0),(0,o._)([(0,O.Cb)()],I.prototype,"parent",void 0),(0,o._)([(0,O.Cb)({readOnly:!0})],I.prototype,"suspended",null),(0,o._)([(0,O.Cb)({readOnly:!0})],I.prototype,"suspendInfo",null),(0,o._)([(0,O.Cb)({readOnly:!0})],I.prototype,"legendEnabled",null),(0,o._)([(0,O.Cb)({type:Boolean,readOnly:!0})],I.prototype,"updating",null),(0,o._)([(0,O.Cb)({readOnly:!0})],I.prototype,"updatingProgress",null),(0,o._)([(0,O.Cb)()],I.prototype,"visible",null),(0,o._)([(0,O.Cb)()],I.prototype,"view",void 0),I=(0,o._)([(0,T.j)("esri.views.layers.LayerView")],I);const z=I},94421:(V,R,n)=>{n.d(R,{Z:()=>D});var o=n(17626),c=n(63290),Z=n(10699),u=n(32917),_=n(77712),O=(n(85931),n(8314),n(90912),n(76898));const D=H=>{let N=class extends H{initialize(){this.handles.add((0,u.on)(()=>this.layer,"refresh",T=>{this.doRefresh(T.dataChanged).catch(I=>{(0,Z.D_)(I)||c.Z.getLogger(this.declaredClass).error(I)})}),"RefreshableLayerView")}};return(0,o._)([(0,_.Cb)()],N.prototype,"layer",void 0),N=(0,o._)([(0,O.j)("esri.layers.mixins.RefreshableLayerView")],N),N}},10023:(V,R,n)=>{n.d(R,{V:()=>g,e:()=>u});var o=n(15861),c=n(62208),Z=n(36630);function u(b){return _.apply(this,arguments)}function _(){return(_=(0,o.Z)(function*(b,F=b.popupTemplate){if((0,c.Wi)(F))return[];const O=yield F.getRequiredFields(b.fieldsIndex),{lastEditInfoEnabled:D}=F,{objectIdField:H,typeIdField:N,globalIdField:T,relationships:I}=b;if(O.includes("*"))return["*"];const z=D?yield(0,Z.CH)(b):[],a=(0,Z.Q0)(b.fieldsIndex,[...O,...z]);return N&&a.push(N),a&&H&&b.fieldsIndex.has(H)&&!a.includes(H)&&a.push(H),a&&T&&b.fieldsIndex.has(T)&&!a.includes(T)&&a.push(T),I&&I.forEach(v=>{const{keyField:m}=v;a&&m&&b.fieldsIndex.has(m)&&!a.includes(m)&&a.push(m)}),a})).apply(this,arguments)}function g(b,F){return b.popupTemplate?b.popupTemplate:(0,c.pC)(F)&&F.defaultPopupTemplateEnabled&&(0,c.pC)(b.defaultPopupTemplate)?b.defaultPopupTemplate:null}}}]);