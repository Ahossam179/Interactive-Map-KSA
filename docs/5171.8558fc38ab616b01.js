"use strict";var qe=Object.defineProperty,ze=Object.defineProperties,Je=Object.getOwnPropertyDescriptors,we=Object.getOwnPropertySymbols,Xe=Object.prototype.hasOwnProperty,He=Object.prototype.propertyIsEnumerable,De=(X,K,g)=>K in X?qe(X,K,{enumerable:!0,configurable:!0,writable:!0,value:g}):X[K]=g,ne=(X,K)=>{for(var g in K||(K={}))Xe.call(K,g)&&De(X,g,K[g]);if(we)for(var g of we(K))He.call(K,g)&&De(X,g,K[g]);return X},ge=(X,K)=>ze(X,Je(K));(self.webpackChunkdemo2=self.webpackChunkdemo2||[]).push([[5171],{90512:(X,K,g)=>{g.d(K,{Z:()=>Q});var F=g(15861);class Q{constructor(){this.declaredRootClass="esri.arcade.featureSetCollection",this._layerById={},this._layerByName={}}add(R,A,N){this._layerById[A]=N,this._layerByName[R]=N}featureSetByName(R,A=!0,N=["*"]){var w=this;return(0,F.Z)(function*(){return void 0===w._layerByName[R]?null:w._layerByName[R]})()}featureSetById(R,A=!0,N=["*"]){var w=this;return(0,F.Z)(function*(){return void 0===w._layerById[R]?null:w._layerById[R]})()}castToText(){return"object, FeatureSetCollection"}}},85171:(X,K,g)=>{g.r(K),g.d(K,{constructAssociationMetaDataFeatureSetFromUrl:()=>ke,constructFeatureSet:()=>re,constructFeatureSetFromPortalItem:()=>Ve,constructFeatureSetFromRelationship:()=>Be,constructFeatureSetFromUrl:()=>le,convertToFeatureSet:()=>Qe,createFeatureSetCollectionFromMap:()=>Ue,createFeatureSetCollectionFromService:()=>We,getPortal:()=>Ge,initialiseMetaDataCache:()=>Ze,lookupUser:()=>Ke});var F=g(15861),Q=g(24263),W=g(84792),R=g(90512),A=g(53997),N=g(88879),w=g(47562),D=g(52724),T=g(95896),O=g(49086),m=g(91510),p=g(57366),C=g(77132),f=g(83947),E=g(45333),v=g(10410);class s{clone(){const e=new s;return e.field=this.field,e.tofieldname=this.tofieldname,e.typeofstat=this.typeofstat,e.workingexpr=this.workingexpr,e}static parseStatField(e,t,n){const r=new s;r.field=e;const d=v.WhereClause.create(t,n),i=function o(b){if("function"===b.parseTree.type){if(0===b.parseTree.args.value.length)return{name:b.parseTree.name,expr:null};if(b.parseTree.args.value.length>1)throw new Error("Statistic does not have 1 or 0 Parameters");const e=v.WhereClause.create((0,f.XF)(b.parseTree.args.value[0],C.Bj.Standardised,b.parameters),b.fieldsIndex);return{name:b.parseTree.name,expr:e}}return null}(d);if(null===i)throw new Error("Invalid Statistic Function");const c=i.name.toUpperCase().trim();if("MIN"===c){if(r.typeofstat="MIN",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MAX"===c){if(r.typeofstat="MAX",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("COUNT"===c)r.typeofstat="COUNT",r.workingexpr=i.expr;else if("STDEV"===c){if(r.typeofstat="STDDEV",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("SUM"===c){if(r.typeofstat="SUM",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("MEAN"===c){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else if("AVG"===c){if(r.typeofstat="AVG",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}else{if("VAR"!==c)throw new Error("Invalid Statistic Function");if(r.typeofstat="VAR",r.workingexpr=i.expr,null===d)throw new Error("Invalid Statistic Function Parameters")}return r}toStatisticsName(){switch(this.typeofstat.toUpperCase()){case"MIN":return"min";case"MAX":return"max";case"SUM":return"sum";case"COUNT":default:return"count";case"VAR":return"var";case"STDDEV":return"stddev";case"AVG":return"avg"}}}var a=g(50011),u=g(65234),_=g(36255),h=g(60466);function I(b){if(!b)return"COUNT";switch(b.toLowerCase()){case"max":return"MAX";case"var":case"variance":return"VAR";case"avg":case"average":case"mean":return"AVG";case"min":return"MIN";case"sum":return"SUM";case"stdev":case"stddev":return"STDDEV";case"count":return"COUNT"}return"COUNT"}class j extends O.Z{constructor(e){super(e),this._decodedStatsfield=[],this._decodedGroupbyfield=[],this._candosimplegroupby=!0,this.phsyicalgroupbyfields=[],this.objectIdField="ROW__ID",this._internalObjectIdField="ROW__ID",this._adaptedFields=[],this.declaredClass="esri.arcade.featureset.actions.Aggregate",this._uniqueIds=1,this._maxQuery=10,this._maxProcessing=10,this._parent=e.parentfeatureset,this._config=e}isTable(){return!0}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,t._wset}return t._wset})()}_isInFeatureSet(){return C.dj.InFeatureSet}_nextUniqueName(e){for(;1===e["T"+this._uniqueIds.toString()];)this._uniqueIds++;const t="T"+this._uniqueIds.toString();return e[t]=1,t}_convertToEsriFieldType(e){return e}_initialiseFeatureSet(){const e={};let t=!1,n=1;const r=this._parent?this._parent.getFieldsIndex():new h.Z([]);for(this.objectIdField="ROW__ID",this.globalIdField="";!1===t;){let i=!1;for(let c=0;c<this._config.groupbyfields.length;c++)if(this._config.groupbyfields[c].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}if(!1===i)for(let c=0;c<this._config.statsfields.length;c++)if(this._config.statsfields[c].name.toLowerCase()===this.objectIdField.toLowerCase()){i=!0;break}!1===i?t=!0:(this.objectIdField="ROW__ID"+n.toString(),n++)}for(const i of this._config.statsfields){const c=new s;c.field=i.name,c.tofieldname=i.name,c.workingexpr=i.expression instanceof v.WhereClause?i.expression:v.WhereClause.create(i.expression,r),c.typeofstat=I(i.statistic),this._decodedStatsfield.push(c)}this._decodedGroupbyfield=[];for(const i of this._config.groupbyfields){const c={name:i.name,singlefield:null,tofieldname:i.name,expression:i.expression instanceof v.WhereClause?i.expression:v.WhereClause.create(i.expression,r)};this._decodedGroupbyfield.push(c)}if(null!==this._parent){this.geometryType=this._parent.geometryType,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField="";for(const i of this._parent.fields)e[i.name.toUpperCase()]=1;this.types=null}else this.geometryType=C.Qk.point,this.typeIdField="",this.types=null,this.spatialReference=new u.Z({wkid:4326});this.fields=[];const d=new s;d.field=this._nextUniqueName(e),d.tofieldname=this.objectIdField,d.workingexpr=v.WhereClause.create(this._parent.objectIdField,this._parent.getFieldsIndex()),d.typeofstat="MIN",this._decodedStatsfield.push(d);for(const i of this._decodedGroupbyfield){const c=new _.Z;if(i.name=this._nextUniqueName(e),c.name=i.tofieldname,c.alias=c.name,(0,f.y5)(i.expression)){const l=this._parent.getField((0,f.zR)(i.expression,C.Bj.Standardised));if(!l)throw new Error("Field is not present for Aggregation");i.name=l.name,i.singlefield=l.name,this.phsyicalgroupbyfields.push(l.name),c.type=l.type}else{c.type=this._convertToEsriFieldType((0,f.DT)(i.expression,this._parent.fields));const l=new _.Z;l.name=i.name,l.alias=l.name,this.phsyicalgroupbyfields.push(i.name),this._adaptedFields.push(new D.yN(l,i.expression)),this._candosimplegroupby=!1}this.fields.push(c)}if(this._adaptedFields.length>0)for(const i of this._parent.fields)this._adaptedFields.push(new D.$X(i));for(let i=0;i<this._decodedStatsfield.length;i++){const c=new _.Z;let l=null;const S=this._decodedStatsfield[i];S.field=this._nextUniqueName(e),S.tofieldname===this.objectIdField&&(this._internalObjectIdField=S.field),c.name=S.tofieldname,c.alias=c.name;const y=null!==S.workingexpr&&(0,f.y5)(S.workingexpr)?(0,f.zR)(S.workingexpr,C.Bj.Standardised):"";switch(this._decodedStatsfield[i].typeofstat){case"SUM":if(""!==y){if(l=this._parent.getField(y),!l)throw new Error("Field is not present for Aggregation");c.type=l.type}else c.type="double";break;case"MIN":case"MAX":if(""!==y){if(l=this._parent.getField(y),!l)throw new Error("Field is not present for Aggregation");c.type=l.type}else c.type="double";break;case"COUNT":c.type="integer";break;case"STDDEV":case"VAR":case"AVG":if(""!==y&&(l=this._parent.getField(y),!l))throw new Error("Field is not present for Aggregation");c.type="double"}this.fields.push(c)}}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}_getFeatures(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=d._maxQuery;return!0===d._checkIfNeedToExpandKnownPage(e,i)?(yield d._expandPagedSet(e,i,0,0,r),d._getFeatures(e,t,n,r)):"success"})()}_getFilteredSet(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){if(""!==e)return new m.Z([],[],!0,null);let c=null;const l={ordered:!1,nowhereclause:!1};if(yield i._ensureLoaded(),null!==n)for(let y=0;y<i._decodedStatsfield.length;y++)if(!0===(0,f.hq)(n,i._decodedStatsfield[y].tofieldname)){l.nowhereclause=!0,n=null;break}if(null!==r){l.ordered=!0;for(let y=0;y<i._decodedStatsfield.length;y++)if(!0===r.scanForField(i._decodedStatsfield[y].tofieldname)){r=null,l.ordered=!1;break}if(null!==r)for(const y of i._decodedGroupbyfield)if(null===y.singlefield&&!0===r.scanForField(y.tofieldname)){r=null,l.ordered=!1;break}}if(!1!==i._candosimplegroupby&&(yield i._parent._canDoAggregates(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,null))){let y=null;n&&(y=i._reformulateWhereClauseWithoutGroupByFields(n));let L=null;r&&(L=i._reformulateOrderClauseWithoutGroupByFields(r));const Z=yield i._parent._getAggregatePagesDataSourceDefinition(i.phsyicalgroupbyfields,i._decodedStatsfield,"",null,y,L,i._internalObjectIdField);return i._checkCancelled(d),c=!0===l.nowhereclause?new m.Z(Z._candidates.slice(0).concat(Z._known.slice(0)),[],!0===l.ordered&&Z._ordered,i._clonePageDefinition(Z.pagesDefinition)):new m.Z(Z._candidates.slice(0),Z._known.slice(0),!0===l.ordered&&Z._ordered,i._clonePageDefinition(Z.pagesDefinition)),c}let S=i._parent;if(i._adaptedFields.length>0&&(S=new D.Xx({parentfeatureset:i._parent,adaptedFields:i._adaptedFields,extraFilter:null})),!0===l.nowhereclause)c=new m.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new T.Z({parentfeatureset:S,orderbyclause:new p.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}});else{let y=S;if(null!==n){let L=null;n&&(L=i._reformulateWhereClauseWithoutGroupByFields(n)),y=new A.Z({parentfeatureset:y,whereclause:L})}c=new m.Z(["GETPAGES"],[],!1,{aggregatefeaturesetpagedefinition:!0,resultOffset:0,resultRecordCount:i._maxQuery,internal:{fullyResolved:!1,workingItem:null,type:"manual",iterator:null,set:[],subfeatureset:new T.Z({parentfeatureset:y,orderbyclause:new p.Z(i.phsyicalgroupbyfields.join(",")+","+i._parent.objectIdField+" ASC")})}})}return c})()}_reformulateWhereClauseWithoutStatsFields(e){for(const t of this._decodedStatsfield)e=(0,f.bB)(e,t.tofieldname,(0,f.zR)(t.workingexpr,C.Bj.Standardised),this._parent.getFieldsIndex());return e}_reformulateWhereClauseWithoutGroupByFields(e){for(const t of this._decodedGroupbyfield)t.tofieldname!==t.name&&(e=(0,f.bB)(e,t.tofieldname,(0,f.zR)(t.expression,C.Bj.Standardised),this._parent.getFieldsIndex()));return e}_reformulateOrderClauseWithoutGroupByFields(e){const t=[];for(const n of this._decodedGroupbyfield)n.tofieldname!==n.name&&t.push({field:n.tofieldname,newfield:n.name});return t.length>0?e.replaceFields(t):e}_clonePageDefinition(e){return null===e?null:!0===e.aggregatefeaturesetpagedefinition?{aggregatefeaturesetpagedefinition:!0,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,internal:e.internal}:this._parent._clonePageDefinition(e)}_refineSetBlock(e,t,n){var r=this;return(0,F.Z)(function*(){return!0===r._checkIfNeedToExpandCandidatePage(e,r._maxQuery)?(yield r._expandPagedSet(e,r._maxQuery,0,0,n),r._refineSetBlock(e,t,n)):(r._checkCancelled(n),r._refineKnowns(e,t),e)})()}_expandPagedSet(e,t,n,r,d){return this._expandPagedSetFeatureSet(e,t,n,r,d)}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){if(!0===e.pagesDefinition.aggregatefeaturesetpagedefinition)return r._sequentialGetPhysicalItem(e,e.pagesDefinition.resultRecordCount,n,[]);const d=yield r._getAgregagtePhysicalPage(e,t,n);for(const i of d){const c={geometry:i.geometry,attributes:{}};for(const l of r._decodedGroupbyfield)c.attributes[l.tofieldname]=i.attributes[l.name];for(const l of r._decodedStatsfield)c.attributes[l.tofieldname]=i.attributes[l.field];r._featureCache[c.attributes[r.objectIdField]]=new N.Z(c)}return d.length})()}_sequentialGetPhysicalItem(e,t,n,r){return new Promise((d,i)=>{null===e.pagesDefinition.internal.iterator&&(e.pagesDefinition.internal.iterator=e.pagesDefinition.internal.subfeatureset.iterator(n)),!0===e.pagesDefinition.internal.fullyResolved||0===t?d(r.length):this._nextAggregateItem(e,t,n,r,c=>{d(null===c?r.length:this._sequentialGetPhysicalItem(e,t-=1,n,r))},i)})}_nextAggregateItem(e,t,n,r,d,i){try{(0,w.X)(e.pagesDefinition.internal.iterator.next()).then(c=>{if(null===c)if(null!==e.pagesDefinition.internal.workingItem){const l=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);r.push(l),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(l.attributes[this.objectIdField]),e.pagesDefinition.internal.fullyResolved=!0,d(null)}else e.pagesDefinition.internal.fullyResolved=!0,d(null);else{const l=this._generateAggregateHash(c);if(null===e.pagesDefinition.internal.workingItem)e.pagesDefinition.internal.workingItem={features:[c],id:l};else{if(l!==e.pagesDefinition.internal.workingItem.id){const S=this._calculateAndAppendAggregateItem(e.pagesDefinition.internal.workingItem);return r.push(S),e.pagesDefinition.internal.workingItem=null,e.pagesDefinition.internal.set.push(S.attributes[this.objectIdField]),t-=1,e.pagesDefinition.internal.workingItem={features:[c],id:l},void d(S)}e.pagesDefinition.internal.workingItem.features.push(c)}this._nextAggregateItem(e,t,n,r,d,i)}},i)}catch(c){i(c)}}_calculateFieldStat(e,t,n){const r=[];for(let d=0;d<e.features.length;d++)if(null!==t.workingexpr){const i=t.workingexpr.calculateValue(e.features[d]);null!==i&&r.push(i)}else r.push(null);switch(t.typeofstat){case"MIN":n.attributes[t.tofieldname]=(0,E.tj)("min",r,-1);break;case"MAX":n.attributes[t.tofieldname]=(0,E.tj)("max",r,-1);break;case"SUM":n.attributes[t.tofieldname]=(0,E.tj)("sum",r,-1);break;case"COUNT":n.attributes[t.tofieldname]=r.length;break;case"VAR":n.attributes[t.tofieldname]=(0,E.tj)("var",r,-1);break;case"STDDEV":n.attributes[t.tofieldname]=(0,E.tj)("stddev",r,-1);break;case"AVG":n.attributes[t.tofieldname]=(0,E.tj)("avg",r,-1)}return!0}_calculateAndAppendAggregateItem(e){const t={attributes:{},geometry:null};for(const r of this._decodedGroupbyfield){const d=r.singlefield?e.features[0].attributes[r.singlefield]:r.expression.calculateValue(e.features[0]);t.attributes[r.tofieldname]=d}for(const r of this._decodedStatsfield)this._calculateFieldStat(e,r,t);const n=[];for(let r=0;r<this._decodedStatsfield.length;r++)n.push(this._calculateFieldStat(e,this._decodedStatsfield[r],t));return this._featureCache[t.attributes[this.objectIdField]]=new N.Z({attributes:t.attributes,geometry:t.geometry}),t}_generateAggregateHash(e){let t="";for(const n of this._decodedGroupbyfield){const r=n.singlefield?e.attributes[n.singlefield]:n.expression.calculateValue(e);t+=null==r?":":":"+r.toString()}return(0,a.F)(t,a.M.String)}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}getFeatureByObjectId(){return(0,F.Z)(function*(){return null})()}static registerAction(){O.Z._featuresetFunctions.groupby=function(e,t){return new j({parentfeatureset:this,groupbyfields:e,statsfields:t})}}}var U=g(3482),P=g(79429),x=g(22386),M=g(91179),B=g(32258),te=g(82054),Fe=(g(26584),g(8314),g(63290),g(15283),g(2865)),Ce=(g(85931),g(21726),g(16730),g(37053),g(20477)),be=g(17253),Y=g(84952),Ee=(g(87183),g(67736),g(90463)),Re=(g(29132),g(24865)),Se=g(67010),Te=(g(13924),g(6871),g(98558)),Ie=g(60776),xe=g(6729);class ie extends O.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerDynamic",this._removeGeometry=!1,this._overrideFields=null,this.formulaCredential=null,this._pageJustIds=!1,this._requestStandardised=!1,this._useDefinitionExpression=!0,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return C.tI}end(){return this._layer}optimisePagingFeatureQueries(e){this._pageJustIds=e}convertQueryToLruCacheKey(e){const t=(0,C.hd)(e.toJSON());return(0,a.F)(t,a.M.String)}loadImpl(){var e=this;return(0,F.Z)(function*(){return!0===e._layer.loaded?(e._initialiseFeatureSet(),e):(yield e._layer.load(),e._initialiseFeatureSet(),e)})()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const e=[];for(const t of this.fields)if("oid"===t.type)e.push(t);else for(const n of this._layer.outFields)if(n.toLowerCase()===t.name.toLowerCase()){e.push(t);break}this.fields=e}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const e=[],t=[];for(const n of this.fields)if("oid"===n.type)e.push(n),t.push(n.name);else for(const r of this._overrideFields)if(r.toLowerCase()===n.name.toLowerCase()){e.push(n),t.push(n.name);break}this.fields=e,this._overrideFields=t}if(this._layer.source&&this._layer.source.sourceJSON){const e=this._layer.source.sourceJSON.currentVersion;!0===this._layer.source.sourceJSON.useStandardizedQueries?(this._databaseType=C.Bj.StandardisedNoInterval,null!=e&&e>=10.61&&(this._databaseType=C.Bj.Standardised)):null!=e&&(e>=10.5&&(this._databaseType=C.Bj.StandardisedNoInterval,this._requestStandardised=!0),e>=10.61&&(this._databaseType=C.Bj.Standardised))}this.objectIdField=this._layer.objectIdField;for(const e of this.fields)"global-id"===e.type&&(this.globalIdField=e.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}_isInFeatureSet(){return C.dj.InFeatureSet}_refineSetBlock(e){return(0,F.Z)(function*(){return e})()}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_runDatabaseProbe(e){var t=this;return(0,F.Z)(function*(){yield t._ensureLoaded();const n=new Y.Z;n.where=e.replace("OBJECTID",t._layer.objectIdField);try{return yield t._layer.queryObjectIds(n),!0}catch(r){return!1}})()}_canUsePagination(){return!(!this._layer.capabilities||!this._layer.capabilities.query||!0!==this._layer.capabilities.query.supportsPagination)}_cacheableFeatureSetSourceKey(){return this._layer.url}pbfSupportedForQuery(e){return!e.outStatistics&&this._layer&&this._layer.capabilities&&this._layer.capabilities.query&&!0===this._layer.capabilities.query.supportsFormatPBF&&!0===this._layer.capabilities.query.supportsQuantizationEditMode}queryPBF(e){var t=this;return(0,F.Z)(function*(){e.quantizationParameters={mode:"edit"};const n=yield(0,Ce.executeQueryPBF)(t._layer.parsedUrl,e,new Te.J({}));return be.default.fromJSON((0,te.cn)(n.data)).unquantize()})()}get gdbVersion(){return this._layer&&this._layer.capabilities&&this._layer.capabilities.data&&this._layer.capabilities.data.isVersioned?this._layer.gdbVersion?this._layer.gdbVersion:"SDE.DEFAULT":""}nativeCapabilities(){return{title:this._layer.title,source:this,canQueryRelated:!0,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:this._requestStandardised}}executeQuery(e,t){const n="execute"===t?Fe.e:"executeForCount"===t?Ee.P:Re.G,r="execute"===t&&this.pbfSupportedForQuery(e);let d=null;if(this.recentlyUsedQueries){const i=this.convertQueryToLruCacheKey(e);d=this.recentlyUsedQueries.getFromCache(i),null===d&&(d=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e),this.recentlyUsedQueries.addToCache(i,d),d=d.catch(c=>{throw this.recentlyUsedQueries.removeFromCache(i),c}))}return this.featureSetQueryInterceptor&&this.featureSetQueryInterceptor.preLayerQueryCallback({layer:this._layer,query:e,method:t}),null===d&&(d=!0!==r?n(this._layer.parsedUrl.path,e):this.queryPBF(e)),d}_getFilteredSet(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){const c=yield i.databaseType();if(i.isTable()&&t&&null!==e&&""!==e)return new m.Z([],[],!0,null);if(i._canUsePagination())return i._getFilteredSetUsingPaging(e,t,n,r,d);let l="",S=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(l=r.constructClause(),S=!0);const y=new Y.Z;y.where=null===n?null===t?"1=1":"":(0,f.zR)(n,c),i._requestStandardised&&(y.sqlFormat="standard"),y.spatialRelationship=i._makeRelationshipEnum(e),y.outSpatialReference=i.spatialReference,y.orderByFields=""!==l?l.split(","):null,y.geometry=null===t?null:t,y.relationParameter=i._makeRelationshipParam(e);let L=yield i.executeQuery(y,"executeForIds");return null===L&&(L=[]),i._checkCancelled(d),new m.Z([],L,S,null)})()}_expandPagedSet(e,t,n,r,d){return this._expandPagedSetFeatureSet(e,t,n,r,d)}_getFilteredSetUsingPaging(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){let c="",l=!1;null!==r&&i._layer.capabilities&&i._layer.capabilities.query&&!0===i._layer.capabilities.query.supportsOrderBy&&(c=r.constructClause(),l=!0);const S=yield i.databaseType();let y=null===n?null===t?"1=1":"":(0,f.zR)(n,S);i._layer.definitionExpression&&i._useDefinitionExpression&&(y=""!==y?"(("+i._layer.definitionExpression+") AND ("+y+"))":i._layer.definitionExpression);let L=i._maxQueryRate();const Z=i._layer.capabilities.query.maxRecordCount;void 0!==Z&&Z<L&&(L=Z);let k=null;if(!0===i._pageJustIds)k=new m.Z([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:i._layer.objectIdField,resultRecordCount:L,resultOffset:0,geometry:null===t?null:t,where:y,orderByFields:c,returnGeometry:!1,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}});else{let z=!0;!0===i._removeGeometry&&(z=!1);const q=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i._layer.outFields?i._layer.outFields:["*"]);k=new m.Z([],["GETPAGES"],l,{spatialRel:i._makeRelationshipEnum(e),relationParam:i._makeRelationshipParam(e),outFields:q.join(","),resultRecordCount:L,resultOffset:0,geometry:null===t?null:t,where:y,orderByFields:c,returnGeometry:z,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})}return yield i._expandPagedSet(k,L,0,1,d),k})()}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,spatialRel:e.spatialRel,relationParam:e.relationParam,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){const d=e.pagesDefinition.internal.lastRetrieved,i=d,c=e.pagesDefinition.internal.lastPage,l=new Y.Z;r._requestStandardised&&(l.sqlFormat="standard"),l.spatialRelationship=e.pagesDefinition.spatialRel,l.relationParameter=e.pagesDefinition.relationParam,l.outFields=e.pagesDefinition.outFields.split(","),l.num=e.pagesDefinition.resultRecordCount,l.start=e.pagesDefinition.internal.lastPage,l.geometry=e.pagesDefinition.geometry,l.where=e.pagesDefinition.where,l.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,l.returnGeometry=e.pagesDefinition.returnGeometry,l.outSpatialReference=r.spatialReference;const S=yield r.executeQuery(l,"execute");if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==c)return"done";for(let y=0;y<S.features.length;y++)e.pagesDefinition.internal.set[i+y]=S.features[y].attributes[r._layer.objectIdField];if(!1===r._pageJustIds)for(let y=0;y<S.features.length;y++)r._featureCache[S.features[y].attributes[r._layer.objectIdField]]=S.features[y];return(void 0===S.exceededTransferLimit&&S.features.length!==e.pagesDefinition.resultRecordCount||!1===S.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=d+S.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,"done"})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFeatures(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=[];if(-1!==t&&void 0===d._featureCache[t]&&i.push(t),!0===d._checkIfNeedToExpandKnownPage(e,d._maxProcessingRate()))return yield d._expandPagedSet(e,d._maxProcessingRate(),0,0,r),d._getFeatures(e,t,n,r);let c=0;for(let y=e._lastFetchedIndex;y<e._known.length;y++){if(e._lastFetchedIndex+=1,c++,void 0===d._featureCache[e._known[y]]){let L=!1;if(null!=d._layer._mode){const Z=d._layer._mode;if(void 0!==Z._featureMap[e._known[y]]){const k=Z._featureMap[e._known[y]];null!==k&&(L=!0,d._featureCache[e._known[y]]=k)}}if(!1===L&&(e._known[y]!==t&&i.push(e._known[y]),i.length>=d._maxProcessingRate()-1))break}if(c>=n&&0===i.length)break}if(0===i.length)return"success";const l=new Y.Z;d._requestStandardised&&(l.sqlFormat="standard"),l.objectIds=i,l.outFields=null!==d._overrideFields?d._overrideFields:d._fieldsIncludingObjectId(d._layer.outFields?d._layer.outFields:["*"]),l.returnGeometry=!0,!0===d._removeGeometry&&(l.returnGeometry=!1),l.outSpatialReference=d.spatialReference;const S=yield d.executeQuery(l,"execute");if(d._checkCancelled(r),void 0!==S.error)throw new Error(S.error);for(let y=0;y<S.features.length;y++)d._featureCache[S.features[y].attributes[d._layer.objectIdField]]=S.features[y];return"success"})()}_getDistinctPages(e,t,n,r,d,i,c,l,S){var y=this;return(0,F.Z)(function*(){yield y._ensureLoaded();const L=yield y.databaseType();let Z=n.parseTree.column;for(let G=0;G<y._layer.fields.length;G++)if(y._layer.fields[G].name.toLowerCase()===Z.toLowerCase()){Z=y._layer.fields[G].name;break}const k=new Y.Z;y._requestStandardised&&(k.sqlFormat="standard");let z=null===i?null===d?"1=1":"":(0,f.zR)(i,L);y._layer.definitionExpression&&y._useDefinitionExpression&&(z=""!==z?"(("+y._layer.definitionExpression+") AND ("+z+"))":y._layer.definitionExpression),k.where=z,k.spatialRelationship=y._makeRelationshipEnum(r),k.relationParameter=y._makeRelationshipParam(r),k.geometry=null===d?null:d,k.returnDistinctValues=!0,k.returnGeometry=!1,k.outFields=[Z];const q=yield y.executeQuery(k,"execute");if(y._checkCancelled(S),!q.hasOwnProperty("features"))throw new Error("Unnexected Result querying statistics from layer");let H=!1;for(let G=0;G<y._layer.fields.length;G++)if(y._layer.fields[G].name===Z){"date"===y._layer.fields[G].type&&(H=!0);break}for(let G=0;G<q.features.length;G++){if(H){const J=q.features[G].attributes[Z];l.push(null!==J?new Date(J):J)}else l.push(q.features[G].attributes[Z]);if(l.length>=c)break}return 0===q.features.length?l:q.features.length===y._layer.capabilities.query.maxRecordCount&&l.length<c?{calculated:!0,result:yield y._getDistinctPages(e+q.features.length,t,n,r,d,i,c,l,S)}:l})()}_distinctStat(e,t,n,r,d,i,c){var l=this;return(0,F.Z)(function*(){return{calculated:!0,result:yield l._getDistinctPages(0,e,t,n,r,d,i,[],c)}})()}isTable(){return this._layer.isTable||null===this._layer.geometryType||"table"===this._layer.type||""===this._layer.geometryType}_countstat(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=yield d.databaseType(),c=new Y.Z;if(d._requestStandardised&&(c.sqlFormat="standard"),d.isTable()&&n&&null!==t&&""!==t)return{calculated:!0,result:0};let l=null===r?null===n?"1=1":"":(0,f.zR)(r,i);return d._layer.definitionExpression&&d._useDefinitionExpression&&(l=""!==l?"(("+d._layer.definitionExpression+") AND ("+l+"))":d._layer.definitionExpression),c.where=l,c.where=l,c.spatialRelationship=d._makeRelationshipEnum(t),c.relationParameter=d._makeRelationshipParam(t),c.geometry=null===n?null:n,c.returnGeometry=!1,{calculated:!0,result:yield d.executeQuery(c,"executeForCount")}})()}_stats(e,t,n,r,d,i,c){var l=this;return(0,F.Z)(function*(){yield l._ensureLoaded();const S=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsSqlExpression,y=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsStatistics,L=l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsDistinct;if("count"===e)return L?l._countstat(e,n,r,d):{calculated:!1};if(!1===y||!1===(0,f.y5)(t)&&!1===S||!1===t.isStandardized)return""!==n||null!==d?{calculated:!1}:l._manualStat(e,t,i,c);if("distinct"===e)return!1===L?""!==n||null!==d?{calculated:!1}:l._manualStat(e,t,i,c):l._distinctStat(e,t,n,r,d,i,c);const Z=yield l.databaseType();if(l.isTable()&&r&&null!==n&&""!==n)return{calculated:!0,result:null};const k=new Y.Z;l._requestStandardised&&(k.sqlFormat="standard");let z=null===d?null===r?"1=1":"":(0,f.zR)(d,Z);l._layer.definitionExpression&&l._useDefinitionExpression&&(z=""!==z?"(("+l._layer.definitionExpression+") AND ("+z+"))":l._layer.definitionExpression),k.where=z,k.spatialRelationship=l._makeRelationshipEnum(n),k.relationParameter=l._makeRelationshipParam(n),k.geometry=null===r?null:r;const q=new Ie.Z;q.statisticType=(0,E.g3)(e),q.onStatisticField=(0,f.zR)(t,Z),q.outStatisticFieldName="ARCADE_STAT_RESULT",k.returnGeometry=!1;let H="ARCADE_STAT_RESULT";k.outStatistics=[q];const G=yield l.executeQuery(k,"execute");if(!G.hasOwnProperty("features")||0===G.features.length)throw new Error("Unnexected Result querying statistics from layer");let J=!1;for(let ee=0;ee<G.fields.length;ee++)if("ARCADE_STAT_RESULT"===G.fields[ee].name.toUpperCase()){H=G.fields[ee].name,"date"===G.fields[ee].type&&(J=!0);break}if(J){let ee=G.features[0].attributes[H];return null!==ee&&(ee=new Date(G.features[0].attributes[H])),{calculated:!0,result:ee}}return{calculated:!0,result:G.features[0].attributes[H]}})()}_stat(e,t,n,r,d,i,c){return this._stats(e,t,n,r,d,i,c)}_canDoAggregates(e,t){var n=this;return(0,F.Z)(function*(){yield n._ensureLoaded();let r=!1;const d=n._layer.capabilities&&n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsSqlExpression;if(void 0!==n._layer.capabilities&&null!==n._layer.capabilities.query&&!0===n._layer.capabilities.query.supportsStatistics&&!0===n._layer.capabilities.query.supportsOrderBy&&(r=!0),r)for(let i=0;i<t.length-1;i++)null!==t[i].workingexpr&&(!1===t[i].workingexpr.isStandardized||!1===(0,f.y5)(t[i].workingexpr)&&!1===d)&&(r=!1);return!1!==r})()}_makeRelationshipEnum(e){if(e.includes("esriSpatialRelRelation"))return"relation";switch(e){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return e}_makeRelationshipParam(e){return e.includes("esriSpatialRelRelation")?e.split(":")[1]:""}_getAggregatePagesDataSourceDefinition(e,t,n,r,d,i,c){var l=this;return(0,F.Z)(function*(){yield l._ensureLoaded();const S=yield l.databaseType();let y="",L=!1,Z=!1;null!==i&&l._layer.capabilities&&l._layer.capabilities.query&&!0===l._layer.capabilities.query.supportsOrderBy&&(y=i.constructClause(),Z=!0),l._layer.capabilities&&l._layer.capabilities.query&&!1===l._layer.capabilities.query.supportsPagination&&(Z=!1,L=!0,y=l._layer.objectIdField);const k=[];for(let G=0;G<t.length;G++){const J=new Ie.Z;J.onStatisticField=null!==t[G].workingexpr?(0,f.zR)(t[G].workingexpr,S):"",J.outStatisticFieldName=t[G].field,J.statisticType=t[G].toStatisticsName(),k.push(J)}""===y&&(y=e.join(","));let z=l._maxQueryRate();const q=l._layer.capabilities.query.maxRecordCount;void 0!==q&&q<z&&(z=q);let H=null===d?null===r?"1=1":"":(0,f.zR)(d,S);return l._layer.definitionExpression&&l._useDefinitionExpression&&(H=""!==H?"(("+l._layer.definitionExpression+") AND ("+H+"))":l._layer.definitionExpression),new m.Z([],["GETPAGES"],Z,{groupbypage:!0,spatialRel:l._makeRelationshipEnum(n),relationParam:l._makeRelationshipParam(n),outFields:["*"],useOIDpagination:L,generatedOid:c,resultRecordCount:z,resultOffset:0,groupByFieldsForStatistics:e,outStatistics:k,geometry:null===r?null:r,where:H,orderByFields:y,returnGeometry:!1,returnIdsOnly:!1,internal:{lastMaxId:-1,set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}})})()}_getAgregagtePhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){let d=e.pagesDefinition.where;!0===e.pagesDefinition.useOIDpagination&&(d=""!==d?"("+d+") AND ("+e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString()+")":e.pagesDefinition.generatedOid+">"+e.pagesDefinition.internal.lastMaxId.toString());const i=e.pagesDefinition.internal.lastRetrieved,c=i,l=e.pagesDefinition.internal.lastPage,S=new Y.Z;if(r._requestStandardised&&(S.sqlFormat="standard"),S.where=d,S.spatialRelationship=e.pagesDefinition.spatialRel,S.relationParameter=e.pagesDefinition.relationParam,S.outFields=e.pagesDefinition.outFields,S.outStatistics=e.pagesDefinition.outStatistics,S.geometry=e.pagesDefinition.geometry,S.groupByFieldsForStatistics=e.pagesDefinition.groupByFieldsForStatistics,S.num=e.pagesDefinition.resultRecordCount,S.start=e.pagesDefinition.internal.lastPage,S.returnGeometry=e.pagesDefinition.returnGeometry,S.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,r.isTable()&&S.geometry&&S.spatialRelationship)return[];const y=yield r.executeQuery(S,"execute");if(r._checkCancelled(n),!y.hasOwnProperty("features"))throw new Error("Unnexected Result querying aggregates from layer");const L=[];if(e.pagesDefinition.internal.lastPage!==l)return[];for(let Z=0;Z<y.features.length;Z++)e.pagesDefinition.internal.set[c+Z]=y.features[Z].attributes[e.pagesDefinition.generatedOid];for(let Z=0;Z<y.features.length;Z++)L.push(new N.Z({attributes:y.features[Z].attributes,geometry:null}));return!0===e.pagesDefinition.useOIDpagination?0===y.features.length?e.pagesDefinition.internal.fullyResolved=!0:e.pagesDefinition.internal.lastMaxId=y.features[y.features.length-1].attributes[e.pagesDefinition.generatedOid]:(void 0===y.exceededTransferLimit&&y.features.length!==e.pagesDefinition.resultRecordCount||!1===y.exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=i+y.features.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,L})()}static create(e,t,n,r,d){const i=new B.default({url:e,outFields:null===t?["*"]:t});return new ie({layer:i,spatialReference:n,lrucache:r,interceptor:d})}relationshipMetaData(){return this._layer&&this._layer.source&&this._layer.source.sourceJSON&&this._layer.source.sourceJSON.relationships?this._layer.source.sourceJSON.relationships:[]}serviceUrl(){return(0,C.US)(this._layer.parsedUrl.path)}queryAttachments(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){if(i._layer.capabilities.data.supportsAttachment&&i._layer.capabilities.operations.supportsQueryAttachments){const c={objectIds:[e],returnMetadata:d};(t&&t>0||n&&n>0)&&(c.size=[t&&t>0?t:0,n&&n>0?n:t+1]),r&&r.length>0&&(c.attachmentTypes=r),i.featureSetQueryInterceptor&&i.featureSetQueryInterceptor.preLayerQueryCallback({layer:i._layer,query:c,method:"attachments"});const l=yield i._layer.queryAttachments(c),S=[];return l&&l[e]&&l[e].forEach(y=>{const L=i._layer.parsedUrl.path+"/"+e.toString()+"/attachments/"+y.id.toString();let Z=null;d&&y.exifInfo&&(Z=xe.Z.convertJsonToArcade(y.exifInfo,!0)),S.push(new x.Z(y.id,y.name,y.contentType,y.size,L,Z))}),S}return[]})()}queryRelatedFeatures(e){var t=this;return(0,F.Z)(function*(){const n={f:"json",relationshipId:e.relationshipId.toString(),definitionExpression:e.where,outFields:e.outFields.join(","),returnGeometry:e.returnGeometry.toString()};null!=e.resultOffset&&(n.resultOffset=e.resultOffset.toString()),null!=e.resultRecordCount&&(n.resultRecordCount=e.resultRecordCount.toString()),e.orderByFields&&(n.orderByFields=e.orderByFields.join(",")),e.objectIds.length>0&&(n.objectIds=e.objectIds.join(",")),e.outSpatialReference&&(n.outSR=JSON.stringify(e.outSpatialReference.toJSON())),t.featureSetQueryInterceptor&&t.featureSetQueryInterceptor.preRequestCallback({layer:t._layer,queryPayload:n,method:"relatedrecords",url:t._layer.parsedUrl.path+"/queryRelatedRecords"});const r=yield(0,W.default)(t._layer.parsedUrl.path+"/queryRelatedRecords",{responseType:"json",query:n});if(r.data){const d={},i=r.data;if(i&&i.relatedRecordGroups){const c=i.spatialReference;for(const l of i.relatedRecordGroups){const S=l.objectId,y=[];for(const L of l.relatedRecords){L.geometry&&(L.geometry.spatialReference=c);const Z=new N.Z({geometry:L.geometry?(0,M.im)(L.geometry):null,attributes:L.attributes});y.push(Z)}d[S]={features:y,exceededTransferLimit:!0===i.exceededTransferLimit}}}return d}throw new Error("Invalid Request")})()}getFeatureByObjectId(e,t){var n=this;return(0,F.Z)(function*(){const r=new Y.Z;r.outFields=t,r.returnGeometry=!1,r.outSpatialReference=n.spatialReference,r.where=n.objectIdField+"="+e.toString(),n.featureSetQueryInterceptor&&n.featureSetQueryInterceptor.preLayerQueryCallback({layer:n._layer,query:r,method:"execute"});const d=yield(0,Fe.e)(n._layer.parsedUrl.path,r);return 1===d.features.length?d.features[0]:null})()}getIdentityUser(){var e=this;return(0,F.Z)(function*(){var n;yield e.load();const t=null==(n=Q.id)?void 0:n.findCredential(e._layer.url);return t?t.userId:null})()}getOwningSystemUrl(){var e=this;return(0,F.Z)(function*(){var d;yield e.load();const t=null==(d=Q.id)?void 0:d.findServerInfo(e._layer.url);if(t)return t.owningSystemUrl;let n=e._layer.url;const r=n.toLowerCase().indexOf("/rest/services");if(n=r>-1?n.substring(0,r):n,n){n+="/rest/info";try{const i=yield(0,W.default)(n,{query:{f:"json"}});let c="";return i.data&&i.data.owningSystemUrl&&(c=i.data.owningSystemUrl),c}catch(i){return""}}return""})()}getDataSourceFeatureSet(){const e=new ie({layer:this._layer,spatialReference:this.spatialReference,outFields:this._overrideFields,includeGeometry:!this._removeGeometry,lrucache:this.recentlyUsedQueries,interceptor:this.featureSetQueryInterceptor});return e._useDefinitionExpression=!1,e}}var Oe=g(16776);class Pe extends O.Z{constructor(e){super(e),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerRelated",this._findObjectId=-1,this._requestStandardised=!1,this._removeGeometry=!1,this._overrideFields=null,this.featureObjectId=null,this.relatedLayer=null,this.relationship=null,e.spatialReference&&(this.spatialReference=e.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=e.layer,this._wset=null,this._findObjectId=e.objectId,this.featureObjectId=e.objectId,this.relationship=e.relationship,this.relatedLayer=e.relatedLayer,void 0!==e.outFields&&(this._overrideFields=e.outFields),void 0!==e.includeGeometry&&(this._removeGeometry=!1===e.includeGeometry)}_maxQueryRate(){return C.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var e=this;return(0,F.Z)(function*(){return yield Promise.all([e._layer.load(),e.relatedLayer.load()]),e._initialiseFeatureSet(),e})()}nativeCapabilities(){return this.relatedLayer.nativeCapabilities()}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this.relatedLayer.geometryType,this.fields=this.relatedLayer.fields.slice(0),null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const t=[],n=[];for(const r of this.fields)if("oid"===r.type)t.push(r),n.push(r.name);else for(const d of this._overrideFields)if(d.toLowerCase()===r.name.toLowerCase()){t.push(r),n.push(r.name);break}this.fields=t,this._overrideFields=n}const e=this._layer.nativeCapabilities();e&&(this._databaseType=e.databaseType,this._requestStandardised=e.requestStandardised),this.objectIdField=this.relatedLayer.objectIdField,this.globalIdField=this.relatedLayer.globalIdField,this.hasM=this.relatedLayer.supportsM,this.hasZ=this.relatedLayer.supportsZ,this.typeIdField=this.relatedLayer.typeIdField,this.types=this.relatedLayer.types}databaseType(){var e=this;return(0,F.Z)(function*(){return yield e.relatedLayer.databaseType(),e._databaseType=e.relatedLayer._databaseType,e._databaseType})()}isTable(){return this.relatedLayer.isTable()}_isInFeatureSet(){return C.dj.InFeatureSet}_candidateIdTransform(e){return e}_getSet(e){var t=this;return(0,F.Z)(function*(){if(null===t._wset){yield t._ensureLoaded();const n=yield t._getFilteredSet("",null,null,null,e);return t._wset=n,n}return t._wset})()}_changeFeature(e){const t={};for(const n of this.fields)t[n.name]=e.attributes[n.name];return new N.Z({geometry:!0===this._removeGeometry?null:e.geometry,attributes:t})}_getFilteredSet(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){if(yield i.databaseType(),i.isTable()&&t&&null!==e&&""!==e)return new m.Z([],[],!0,null);const c=i._layer.nativeCapabilities();if(!1===c.canQueryRelated)return new m.Z([],[],!0,null);if(c.capabilities.queryRelated&&c.capabilities.queryRelated.supportsPagination)return i._getFilteredSetUsingPaging(e,t,n,r,d);let l="",S=!1;null!==r&&c.capabilities&&c.capabilities.queryRelated&&!0===c.capabilities.queryRelated.supportsOrderBy&&(l=r.constructClause(),S=!0);const y=new Se.Z;y.objectIds=[i._findObjectId];const L=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map(J=>J.name):["*"]);y.outFields=L,y.relationshipId=i.relationship.id,y.where="1=1";let Z=!0;!0===i._removeGeometry&&(Z=!1),y.returnGeometry=Z,i._requestStandardised&&(y.sqlFormat="standard"),y.outSpatialReference=i.spatialReference,y.orderByFields=""!==l?l.split(","):null;const k=yield c.source.queryRelatedFeatures(y);i._checkCancelled(d);const z=k[i._findObjectId]?k[i._findObjectId].features:[],q=[];for(let J=0;J<z.length;J++)i._featureCache[z[J].attributes[i.relatedLayer.objectIdField]]=z[J],q.push(z[J].attributes[i.relatedLayer.objectIdField]);const H=t&&null!==e&&""!==e,G=null!=n;return new m.Z(H||G?q:[],H||G?[]:q,S,null)})()}_fieldsIncludingObjectId(e){if(null===e)return[this.objectIdField];const t=e.slice(0);if(t.includes("*"))return t;let n=!1;for(const r of t)if(r.toUpperCase()===this.objectIdField.toUpperCase()){n=!0;break}return!1===n&&t.push(this.objectIdField),t}_getFilteredSetUsingPaging(e,t,n,r,d){var i=this;return(0,F.Z)(function*(){let c="",l=!1;const S=i._layer.nativeCapabilities();null!==r&&S&&S.capabilities.queryRelated&&!0===S.capabilities.queryRelated.supportsOrderBy&&(c=r.constructClause(),l=!0),yield i.databaseType();let L=i._maxQueryRate();const Z=S.capabilities.query.maxRecordCount;void 0!==Z&&Z<L&&(L=Z);const k=t&&null!==e&&""!==e,z=null!=n;let q=null,H=!0;!0===i._removeGeometry&&(H=!1);const G=null!==i._overrideFields?i._overrideFields:i._fieldsIncludingObjectId(i.relatedLayer.fields?i.relatedLayer.fields.map(J=>J.name):["*"]);return q=new m.Z(k||z?["GETPAGES"]:[],k||z?[]:["GETPAGES"],l,{outFields:G.join(","),resultRecordCount:L,resultOffset:0,objectIds:[i._findObjectId],where:"1=1",orderByFields:c,returnGeometry:H,returnIdsOnly:"false",internal:{set:[],lastRetrieved:0,lastPage:0,fullyResolved:!1}}),yield i._expandPagedSet(q,L,0,0,d),q})()}_expandPagedSet(e,t,n,r,d){return this._expandPagedSetFeatureSet(e,t,n,r,d)}_clonePageDefinition(e){return null===e?null:!0!==e.groupbypage?{groupbypage:!1,outFields:e.outFields,resultRecordCount:e.resultRecordCount,resultOffset:e.resultOffset,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}:{groupbypage:!0,outFields:e.outFields,resultRecordCount:e.resultRecordCount,useOIDpagination:e.useOIDpagination,generatedOid:e.generatedOid,groupByFieldsForStatistics:e.groupByFieldsForStatistics,resultOffset:e.resultOffset,outStatistics:e.outStatistics,geometry:e.geometry,where:e.where,objectIds:e.objectIds,orderByFields:e.orderByFields,returnGeometry:e.returnGeometry,returnIdsOnly:e.returnIdsOnly,internal:e.internal}}_getPhysicalPage(e,t,n){var r=this;return(0,F.Z)(function*(){const d=e.pagesDefinition.internal.lastRetrieved,i=d,c=e.pagesDefinition.internal.lastPage,l=r._layer.nativeCapabilities(),S=new Se.Z;!0===r._requestStandardised&&(S.sqlFormat="standard"),S.relationshipId=r.relationship.id,S.objectIds=e.pagesDefinition.objectIds,S.resultOffset=e.pagesDefinition.internal.lastPage,S.resultRecordCount=e.pagesDefinition.resultRecordCount,S.outFields=e.pagesDefinition.outFields.split(","),S.where=e.pagesDefinition.where,S.orderByFields=""!==e.pagesDefinition.orderByFields?e.pagesDefinition.orderByFields.split(","):null,S.returnGeometry=e.pagesDefinition.returnGeometry,S.outSpatialReference=r.spatialReference;const y=yield l.source.queryRelatedFeatures(S);if(r._checkCancelled(n),e.pagesDefinition.internal.lastPage!==c)return 0;const L=y[r._findObjectId]?y[r._findObjectId].features:[];for(let k=0;k<L.length;k++)e.pagesDefinition.internal.set[i+k]=L[k].attributes[r.relatedLayer.objectIdField];for(let k=0;k<L.length;k++)r._featureCache[L[k].attributes[r.relatedLayer.objectIdField]]=L[k];return L.length!==e.pagesDefinition.resultRecordCount&&(!y[r._findObjectId]||!1===y[r._findObjectId].exceededTransferLimit)&&(e.pagesDefinition.internal.fullyResolved=!0),e.pagesDefinition.internal.lastRetrieved=d+L.length,e.pagesDefinition.internal.lastPage+=e.pagesDefinition.resultRecordCount,L.length})()}_getFeatures(e,t,n,r){var d=this;return(0,F.Z)(function*(){const i=[];-1!==t&&void 0===d._featureCache[t]&&i.push(t);const c=d._maxQueryRate();if(!0===d._checkIfNeedToExpandKnownPage(e,c))return yield d._expandPagedSet(e,c,0,0,r),d._getFeatures(e,t,n,r);let l=0;for(let S=e._lastFetchedIndex;S<e._known.length&&(l++,l<=n&&(e._lastFetchedIndex+=1),!("GETPAGES"!==e._known[S]&&void 0===d._featureCache[e._known[S]]&&(e._known[S]!==t&&i.push(e._known[S]),i.length>n)))&&!(l>=n&&0===i.length);S++);if(0===i.length)return"success";throw new Error("Unaccounted for Features. Not in Feature Collection")})()}_refineSetBlock(e,t,n){return(0,F.Z)(function*(){return e})()}_stat(e,t,n,r,d,i,c){return(0,F.Z)(function*(){return{calculated:!1}})()}get gdbVersion(){return this.relatedLayer.gdbVersion}_canDoAggregates(e,t,n,r,d){return(0,F.Z)(function*(){return!1})()}relationshipMetaData(){return this.relatedLayer.relationshipMetaData()}serviceUrl(){return this.relatedLayer.serviceUrl()}queryAttachments(e,t,n,r,d){return this.relatedLayer.queryAttachments(e,t,n,r,d)}getFeatureByObjectId(e,t){return this.relatedLayer.getFeatureByObjectId(e,t)}getOwningSystemUrl(){return this.relatedLayer.getOwningSystemUrl()}getIdentityUser(){return this.relatedLayer.getIdentityUser()}getDataSourceFeatureSet(){return this.relatedLayer}}var V=g(53791),Ae=g(84687),Le=g(55463);function Ze(){null===V.Z.applicationCache&&(V.Z.applicationCache=new V.Z)}function se(b,e){return ae.apply(this,arguments)}function ae(){return(ae=(0,F.Z)(function*(b,e){if(V.Z.applicationCache){const t=V.Z.applicationCache.getLayerInfo(b);if(t){const d=yield t;return new B.default({url:b,outFields:e,sourceJSON:d})}const n=new B.default({url:b,outFields:e}),r=(0,F.Z)(function*(){return yield n.load(),n.sourceJSON})();if(V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(b,r);try{return yield r,n}catch(d){throw V.Z.applicationCache.clearLayerInfo(b),d}}return yield r,n}return new B.default({url:b,outFields:e})})).apply(this,arguments)}function le(b,e,t,n,r){return oe.apply(this,arguments)}function oe(){return(oe=(0,F.Z)(function*(b,e,t,n,r,d=null){return re(yield se(b,["*"]),e,t,n,r,d)})).apply(this,arguments)}function re(b,e=null,t=null,n=!0,r=null,d=null){return!0===b._hasMemorySource()?new Oe.Z({layer:b,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:d}):new ie({layer:b,spatialReference:e,outFields:t,includeGeometry:n,lrucache:r,interceptor:d})}function Ne(b){return ue.apply(this,arguments)}function ue(){return(ue=(0,F.Z)(function*(b){if(null!==V.Z.applicationCache){const t=V.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}const e=(0,F.Z)(function*(){const t=yield(0,W.default)(b,{responseType:"json",query:{f:"json"}});return t.data?t.data:null})();if(null!==V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(b,e);try{return yield e}catch(t){throw V.Z.applicationCache.clearLayerInfo(b),t}}return e})).apply(this,arguments)}function je(b,e){return de.apply(this,arguments)}function de(){return(de=(0,F.Z)(function*(b,e){const t="QUERYDATAELEMTS:"+e.toString()+":"+b;if(null!==V.Z.applicationCache){const r=V.Z.applicationCache.getLayerInfo(t);if(null!==r)return r}const n=(0,F.Z)(function*(){const r=yield(0,W.default)(b+"/queryDataElements",{method:"post",responseType:"json",query:{layers:JSON.stringify([e.toString()]),f:"json"}});if(r.data){const d=r.data;if(d.layerDataElements&&d.layerDataElements[0])return d.layerDataElements[0]}throw new Error("Not Found")})();if(null!==V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(t,n);try{return yield n}catch(r){throw V.Z.applicationCache.clearLayerInfo(t),r}}return n})).apply(this,arguments)}function ve(b){return ce.apply(this,arguments)}function ce(){return(ce=(0,F.Z)(function*(b){if(null!==V.Z.applicationCache){const t=V.Z.applicationCache.getLayerInfo(b);if(null!==t)return t}const e=(0,F.Z)(function*(){const t=yield(0,W.default)(b,{responseType:"json",query:{f:"json"}});if(t.data){const n=t.data;return n.layers||(n.layers=[]),n.tables||(n.tables=[]),n}return{layers:[],tables:[]}})();if(null!==V.Z.applicationCache){V.Z.applicationCache.setLayerInfo(b,e);try{return yield e}catch(t){throw V.Z.applicationCache.clearLayerInfo(b),t}}return e})).apply(this,arguments)}function ke(b,e){return he.apply(this,arguments)}function he(){return(he=(0,F.Z)(function*(b,e){const t={metadata:null,networkId:-1,unVersion:3,terminals:[],queryelem:null,layerNameLkp:{},lkp:null},n=yield ve(b);if(t.metadata=n,n.controllerDatasetLayers&&null!=n.controllerDatasetLayers.utilityNetworkLayerId){if(n.layers)for(const i of n.layers)t.layerNameLkp[i.id]=i.name;if(n.tables)for(const i of n.tables)t.layerNameLkp[i.id]=i.name;const r=n.controllerDatasetLayers.utilityNetworkLayerId;t.networkId=r;const d=yield je(b,r);if(d){t.queryelem=d,t.queryelem&&t.queryelem.dataElement&&void 0!==t.queryelem.dataElement.schemaGeneration&&(t.unVersion=t.queryelem.dataElement.schemaGeneration),t.lkp={},t.queryelem.dataElement.domainNetworks||(t.queryelem.dataElement.domainNetworks=[]);for(const c of t.queryelem.dataElement.domainNetworks){for(const l of c.edgeSources?c.edgeSources:[]){const S={layerId:l.layerId,sourceId:l.sourceId,className:t.layerNameLkp[l.layerId]?t.layerNameLkp[l.layerId]:null};S.className&&(t.lkp[S.className]=S)}for(const l of c.junctionSources?c.junctionSources:[]){const S={layerId:l.layerId,sourceId:l.sourceId,className:t.layerNameLkp[l.layerId]?t.layerNameLkp[l.layerId]:null};S.className&&(t.lkp[S.className]=S)}}if(t.queryelem.dataElement.terminalConfigurations)for(const c of t.queryelem.dataElement.terminalConfigurations)for(const l of c.terminals)t.terminals.push({terminalId:l.terminalId,terminalName:l.terminalName});const i=yield Ne(b+"/"+r);if(i.systemLayers&&null!=i.systemLayers.associationsTableId){const c=[];t.unVersion>=4&&(c.push("STATUS"),c.push("PERCENTALONG"));let l=yield le(b+"/"+i.systemLayers.associationsTableId.toString(),e,["OBJECTID","FROMNETWORKSOURCEID","TONETWORKSOURCEID","FROMGLOBALID","TOGLOBALID","TOTERMINALID","FROMTERMINALID","ASSOCIATIONTYPE","ISCONTENTVISIBLE","GLOBALID",...c],!1,null,null);return yield l.load(),t.unVersion>=4&&(l=l.filter(v.WhereClause.create("STATUS NOT IN (1, 2, 3, 4, 5, 6, 7, 9, 10, 11, 12, 13, 14, 15, 17, 18, 19, 20, 21, 22, 23, 25, 26, 27, 28, 29, 30, 31, 33, 34, 35, 36, 37, 38, 39, 41, 42, 43, 44, 45, 46, 47, 49, 50, 51, 52, 53, 54, 55, 57, 58, 59, 60, 61, 62,63)",l.getFieldsIndex())),yield l.load()),{lkp:t.lkp,associations:l,unVersion:t.unVersion,terminals:t.terminals}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}}return{associations:null,unVersion:t.unVersion,lkp:null,terminals:[]}})).apply(this,arguments)}function Be(b,e,t){return fe.apply(this,arguments)}function fe(){return(fe=(0,F.Z)(function*(b,e,t,n=null,r=null,d=!0,i=null,c=null){let l=b.serviceUrl();if(!l)return null;l="/"===l.charAt(l.length-1)?l+e.relatedTableId.toString():l+"/"+e.relatedTableId.toString();const S=yield le(l,n,r,d,i,c);return new Pe({layer:b,relatedLayer:S,relationship:e,objectId:t,spatialReference:n,outFields:r,includeGeometry:d,lrucache:i,interceptor:c})})).apply(this,arguments)}A.Z.registerAction(),j.registerAction(),T.Z.registerAction(),U.Z.registerAction(),P.Z.registerAction();class Me extends R.Z{constructor(e,t=null,n=null,r=null){super(),this._map=e,this._overridespref=t,this.lrucache=n,this.interceptor=r,this._instantLayers=[]}_makeAndAddFeatureSet(e,t=!0,n=null){const r=re(e,this._overridespref,null===n?["*"]:n,t,this.lrucache,this.interceptor);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}featureSetByName(e,t=!0,n=null){var r=this;return(0,F.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetByName(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);for(let c=0;c<r._instantLayers.length;c++){const l=r._instantLayers[c];if(l.opitem.title===e&&l.includeGeometry===t&&l.outFields===d)return r._instantLayers[c].featureset}const i=r._map.allLayers.find(c=>c instanceof B.default&&c.title===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const c=r._map.tables.find(l=>!!(l.title&&l.title===e||l.title&&l.title===e));if(c){if(c instanceof B.default)return r._makeAndAddFeatureSet(c,t,n);if(!c._materializedTable){const l=c.outFields?c:ge(ne({},c),{outFields:["*"]});c._materializedTable=new B.default(l)}return yield c._materializedTable.load(),r._makeAndAddFeatureSet(c._materializedTable,t,n)}}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,F.Z)(function*(){if(void 0!==r._map.loaded&&void 0!==r._map.load&&!1===r._map.loaded)return yield r._map.load(),r.featureSetById(e,t,n);null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);for(let c=0;c<r._instantLayers.length;c++){const l=r._instantLayers[c];if(l.opitem.id===e&&l.includeGeometry===t&&l.outFields===d)return r._instantLayers[c].featureset}const i=r._map.allLayers.find(c=>c instanceof B.default&&c.id===e);if(i)return r._makeAndAddFeatureSet(i,t,n);if(r._map.tables){const c=r._map.tables.find(l=>l.id===e);if(c){if(c instanceof B.default)return r._makeAndAddFeatureSet(c,t,n);if(!c._materializedTable){const l=ge(ne({},c),{outFields:["*"]});c._materializedTable=new B.default(l)}return yield c._materializedTable.load(),r._makeAndAddFeatureSet(c._materializedTable,t,n)}}return null})()}}class _e extends R.Z{constructor(e,t=null,n=null,r=null){super(),this._url=e,this._overridespref=t,this.lrucache=n,this.interceptor=r,this.metadata=null,this._instantLayers=[]}get url(){return this._url}_makeAndAddFeatureSet(e,t=!0,n=null){const r=re(e,this._overridespref,null===n?["*"]:n,t,this.lrucache);return this._instantLayers.push({featureset:r,opitem:e,includeGeometry:t,outFields:JSON.stringify(n)}),r}_loadMetaData(){var e=this;return(0,F.Z)(function*(){const t=yield ve(e._url);return e.metadata=t,t})()}load(){return this._loadMetaData()}clone(){return new _e(this._url,this._overridespref,this.lrucache,this.interceptor)}featureSetByName(e,t=!0,n=null){var r=this;return(0,F.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);for(let l=0;l<r._instantLayers.length;l++){const S=r._instantLayers[l];if(S.opitem.title===e&&S.includeGeometry===t&&S.outFields===d)return r._instantLayers[l].featureset}const i=yield r._loadMetaData();let c=null;for(const l of i.layers?i.layers:[])l.name===e&&(c=l);if(!c)for(const l of i.tables?i.tables:[])l.name===e&&(c=l);if(c){const l=yield se(r._url+"/"+c.id,["*"]);return r._makeAndAddFeatureSet(l,t,n)}return null})()}featureSetById(e,t=!0,n=["*"]){var r=this;return(0,F.Z)(function*(){null===n&&(n=["*"]),n=(n=n.slice(0)).sort();const d=JSON.stringify(n);e=null!=e?e.toString():"";for(let l=0;l<r._instantLayers.length;l++){const S=r._instantLayers[l];if(S.opitem.id===e&&S.includeGeometry===t&&S.outFields===d)return r._instantLayers[l].featureset}const i=yield r._loadMetaData();let c=null;for(const l of i.layers?i.layers:[])null!=l.id&&l.id.toString()===e&&(c=l);if(!c)for(const l of i.tables?i.tables:[])null!=l.id&&l.id.toString()===e&&(c=l);if(c){const l=yield se(r._url+"/"+c.id,["*"]);return r._makeAndAddFeatureSet(l,t,n)}return null})()}}function Ue(b,e,t=null,n=null){return new Me(b,e,t,n)}function We(b,e,t=null,n=null){return new _e(b,e,t,n)}function Ge(b,e){return null===b?e:new Ae.Z({url:b.field("url")})}function Ke(b,e,t){return pe.apply(this,arguments)}function pe(){return(pe=(0,F.Z)(function*(b,e,t){if(!Q.id.findCredential(b.restUrl))return null;if("loaded"===b.loadStatus&&""===e&&b.user&&b.user.sourceJSON&&!1===t)return b.user.sourceJSON;if(""===e){const r=yield(0,W.default)(b.restUrl+"/community/self",{responseType:"json",query:ne({f:"json"},!1===t?{}:{returnUserLicenseTypeExtensions:!0})});if(r.data){const d=r.data;if(d&&d.username)return d}return null}const n=yield(0,W.default)(b.restUrl+"/community/users/"+e,{responseType:"json",query:{f:"json"}});if(n.data){const r=n.data;return r.error?null:r}return null})).apply(this,arguments)}function Qe(b,e,t,n,r){if(null===b)return null;if(b instanceof B.default){switch(e){case"datasource":return re(b,r,b.outFields,!0,t,n).getDataSourceFeatureSet();case"parent":case"root":return re(b,r,b.outFields,!0,t,n)}return null}if(b instanceof O.Z)switch(e){case"datasource":return b.getDataSourceFeatureSet();case"parent":return b;case"root":return b.getRootFeatureSet()}return null}function Ve(b,e,t,n,r,d,i){return ye.apply(this,arguments)}function ye(){return(ye=(0,F.Z)(function*(b,e,t,n,r,d,i,c=null){if(V.Z.applicationCache){const S=V.Z.applicationCache.getLayerInfo(b+":"+d.url);if(S){const y=yield S;return re(new B.default({url:(0,C.US)(y.url)+"/"+e,outFields:["*"]}),t,n,r,i,c)}}const l=new Le.default({id:b,portal:d}).load();V.Z.applicationCache&&V.Z.applicationCache.setLayerInfo(b+":"+d.url,l);try{const S=yield l;return re(new B.default({url:(0,C.US)(S.url)+"/"+e,outFields:["*"]}),t,n,r,i,c)}catch(S){throw V.Z.applicationCache&&V.Z.applicationCache.clearLayerInfo(b+":"+d.url),S}})).apply(this,arguments)}},52724:(X,K,g)=>{g.d(K,{$X:()=>m,QP:()=>p,TO:()=>C,Xx:()=>E,yN:()=>f});var F=g(15861),Q=g(88879),W=g(27187),R=g(49086),A=g(91510),N=g(77132),w=g(83947),D=g(10410),T=g(65234);class O{constructor(o){this.field=o,this.sqlRewritable=!1}postInitialization(o,s){}}class m extends O{constructor(o){super(o),this.sqlRewritable=!0}extractValue(o){return o.attributes[this.field.name]}rewriteSql(o){return{rewritten:this.sqlRewritable,where:o}}}class p extends O{constructor(o,s,a){super((0,N.JW)(o)),this.originalField=o,this.sqlRewritable=!0,this.field.name=s,this.field.alias=a}rewriteSql(o,s){return{rewritten:this.sqlRewritable,where:(0,w.bB)(o,this.field.name,this.originalField.name,s.getFieldsIndex())}}extractValue(o){return o.attributes[this.originalField.name]}}let C=(()=>{class v extends O{constructor(s,a,u){super(s),this.codefield=a,this.lkp=u,this.reverseLkp={};for(const _ in u)this.reverseLkp[u[_]]=_;this.sqlRewritable=!0}rewriteSql(s,a){const u=this.evaluateNodeToWhereClause(s.parseTree,N.Bj.Standardised,this.field.name,this.codefield instanceof D.WhereClause?(0,w.zR)(this.codefield,N.Bj.Standardised):this.codefield,s.parameters);return u.includes(v.BADNESS)?{rewritten:!1,where:s}:{rewritten:this.sqlRewritable,where:D.WhereClause.create(u,a._parent.getFieldsIndex())}}evaluateNodeToWhereClause(s,a,u=null,_=null,h){let I,j,U,P;switch(s.type){case"interval":return(0,w.TE)(this.evaluateNodeToWhereClause(s.value,a,u,_,h),s.qualifier,s.op);case"case-expression":{let x=" CASE ";"simple"===s.format&&(x+=this.evaluateNodeToWhereClause(s.operand,a,u,v.BADNESS,h));for(let M=0;M<s.clauses.length;M++)x+=" WHEN "+this.evaluateNodeToWhereClause(s.clauses[M].operand,a,u,v.BADNESS,h)+" THEN "+this.evaluateNodeToWhereClause(s.clauses[M].value,a,u,v.BADNESS,h);return null!==s.else&&(x+=" ELSE "+this.evaluateNodeToWhereClause(s.else,a,u,v.BADNESS,h)),x+=" END ",x}case"parameter":{const x=h[s.value.toLowerCase()];if("string"==typeof x)return"'"+h[s.value.toLowerCase()].toString().replace(/'/g,"''")+"'";if(x instanceof Date)return(0,w.oX)(x,a);if(x instanceof Array){const M=[];for(let B=0;B<x.length;B++)"string"==typeof x[B]?M.push("'"+x[B].toString().replace(/'/g,"''")+"'"):x[B]instanceof Date?M.push((0,w.oX)(x[B],a)):M.push(x[B].toString());return M}return x.toString()}case"expression-list":j=[];for(const x of s.value)j.push(this.evaluateNodeToWhereClause(x,a,u,_,h));return j;case"unary-expression":return" ( NOT "+this.evaluateNodeToWhereClause(s.expr,a,u,v.BADNESS,h)+" ) ";case"binary-expression":switch(s.operator){case"AND":return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" AND "+this.evaluateNodeToWhereClause(s.right,a,u,_,h)+") ";case"OR":return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" OR "+this.evaluateNodeToWhereClause(s.right,a,u,_,h)+") ";case"IS":if("null"!==s.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" IS NULL )";case"ISNOT":if("null"!==s.right.type)throw new Error("Unsupported RHS for IS");return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" IS NOT NULL )";case"IN":if(I=[],"expression-list"===s.right.type){if("column-reference"===s.left.type&&s.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let M=!0;for(const B of s.right.value){if("string"!==B.type){M=!1;break}if(void 0===this.lkp[B.value]){M=!1;break}x.push(this.lkp[B.value].toString())}if(M)return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" IN ("+x.join(",")+")) "}return I=this.evaluateNodeToWhereClause(s.right,a,u,_,h)," ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" IN ("+I.join(",")+")) "}return P=this.evaluateNodeToWhereClause(s.right,a,u,_,h),P instanceof Array?" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" IN ("+P.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" IN ("+P+")) ";case"NOT IN":if(I=[],"expression-list"===s.right.type){if("column-reference"===s.left.type&&s.left.column.toUpperCase()===this.field.name.toUpperCase()){const x=[];let M=!0;for(const B of s.right.value){if("string"!==B.type){M=!1;break}if(void 0===this.lkp[B.value]){M=!1;break}x.push(this.lkp[B.value].toString())}if(M)return" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" NOT IN ("+x.join(",")+")) "}return I=this.evaluateNodeToWhereClause(s.right,a,u,_,h)," ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" NOT IN ("+I.join(",")+")) "}return P=this.evaluateNodeToWhereClause(s.right,a,u,_,h),P instanceof Array?" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" NOT IN ("+P.join(",")+")) ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,_,h)+" NOT IN ("+P+")) ";case"BETWEEN":return U=this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)," ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" BETWEEN "+U[0]+" AND "+U[1]+" ) ";case"NOTBETWEEN":return U=this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)," ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" NOT BETWEEN "+U[0]+" AND "+U[1]+" ) ";case"LIKE":return""!==s.escape?" ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)+" ESCAPE '"+s.escape+"') ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)+") ";case"NOT LIKE":return""!==s.escape?" ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" NOT LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)+" ESCAPE '"+s.escape+"') ":" ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" NOT LIKE "+this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)+") ";case"<>":case"=":if("column-reference"===s.left.type&&"string"===s.right.type){if(s.left.column.toUpperCase()===this.field.name.toUpperCase()&&void 0!==this.lkp[s.right.value.toString()])return" ("+_+" "+s.operator+" "+this.lkp[s.right.value.toString()].toString()+") "}else if("column-reference"===s.right.type&&"string"===s.left.type&&s.right.column.toUpperCase()===this.field.name.toUpperCase())return" ("+this.lkp[s.right.value.toString()].toString()+" "+s.operator+" "+_+") ";return" ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" "+s.operator+" "+this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)+") ";case"<":case">":case">=":case"<=":case"*":case"-":case"+":case"/":return" ("+this.evaluateNodeToWhereClause(s.left,a,u,v.BADNESS,h)+" "+s.operator+" "+this.evaluateNodeToWhereClause(s.right,a,u,v.BADNESS,h)+") "}case"null":return"null";case"boolean":return!0===s.value?"1":"0";case"string":return"'"+s.value.toString().replace(/'/g,"''")+"'";case"timestamp":case"date":return(0,w.oX)(s.value,a);case"number":return s.value.toString();case"current-time":return(0,w.vR)("date"===s.mode,a);case"column-reference":return u&&u.toLowerCase()===s.column.toLowerCase()?"("+_+")":s.column;case"function":{const x=this.evaluateNodeToWhereClause(s.args,a,u,v.BADNESS,h);return(0,w.fz)(s.name,x,a)}}throw new Error("Unsupported sql syntax "+s.type)}extractValue(s){return this.codefield instanceof D.WhereClause?this.reverseLkp[this.codefield.calculateValueCompiled(s)]:this.reverseLkp[s.attributes[this.codefield]]}}return v.BADNESS="_!!!_BAD_LKP_!!!!",v})();class f extends O{constructor(o,s){super(o),this.sql=s}rewriteSql(o,s){return{rewritten:!0,where:(0,w.bB)(o,this.field.name,(0,w.zR)(this.sql,N.Bj.Standardised),s.getFieldsIndex())}}extractValue(o){return this.sql.calculateValueCompiled(o)}}class E extends R.Z{constructor(o){super(o),this._calcFunc=null,this.declaredClass="esri.arcade.featureset.actions.Adapted",this.adaptedFields=null,this._extraFilter=null,this._extraFilter=o.extraFilter,this._parent=o.parentfeatureset,this._maxProcessing=30,this.adaptedFields=o.adaptedFields}static findField(o,s){for(const a of o)if(a.name.toLowerCase()===s.toString().toLowerCase())return a;return null}_initialiseFeatureSet(){null!==this._parent?(this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.spatialReference=new T.Z({wkid:4326}),this.objectIdField="",this.globalIdField="",this.geometryType=N.Qk.point,this.typeIdField="",this.types=null),this.fields=[];for(const o of this.adaptedFields)o.postInitialization(this,this._parent),this.fields.push(o.field)}_getSet(o){var s=this;return(0,F.Z)(function*(){if(null===s._wset){yield s._ensureLoaded();let a=null;return a=s._extraFilter?yield s._getFilteredSet("",null,null,null,o):yield s._parent._getSet(o),s._checkCancelled(o),s._wset=new A.Z(a._candidates.slice(0),a._known.slice(0),a._ordered,s._clonePageDefinition(a.pagesDefinition)),s._wset}return s._wset})()}_isInFeatureSet(o){return this._parent._isInFeatureSet(o)}_getFeatures(o,s,a,u){var _=this;return(0,F.Z)(function*(){const h=[];-1!==s&&void 0===_._featureCache[s]&&h.push(s);const I=_._maxQueryRate();if(!0===_._checkIfNeedToExpandKnownPage(o,I))return yield _._expandPagedSet(o,I,0,0,u),_._getFeatures(o,s,a,u);let j=0;for(let x=o._lastFetchedIndex;x<o._known.length&&(j++,j<=a&&(o._lastFetchedIndex+=1),!(void 0===_._featureCache[o._known[x]]&&(o._known[x]!==s&&h.push(o._known[x]),h.length>=I)));x++);if(0===h.length)return"success";o=new A.Z([],h,o._ordered,null);const U=Math.min(h.length,a);yield _._parent._getFeatures(o,-1,U,u),_._checkCancelled(u);const P=[];for(let x=0;x<U;x++){const M=_._parent._featureFromCache(h[x]);void 0!==M&&P.push({geometry:M.geometry,attributes:M.attributes,id:h[x]})}for(const x of P){const M=[];for(const B of _.adaptedFields)M[B.field.name]=B.extractValue(x);_._featureCache[x.id]=new Q.Z({attributes:M,geometry:(0,W.r1)(x.geometry)})}return"success"})()}_fetchAndRefineFeatures(){return(0,F.Z)(function*(){throw new Error("Fetch and Refine should not be called in this featureset")})()}_getFilteredSet(o,s,a,u,_){var h=this;return(0,F.Z)(function*(){let I=!1;const j=h._reformulateWithoutAdaptions(a);I=j.cannot,a=j.where;let U=!1;if(null!==u){U=!0;const M=[];for(const B of h.adaptedFields)if(!(B instanceof m)&&!0===u.scanForField(B.field.name)){if(!(B instanceof p)){u=null,U=!1;break}M.push({field:B.field.name,newfield:B.originalField.name})}u&&M.length>0&&(u=u.replaceFields(M))}null!==a?null!==h._extraFilter&&(a=(0,w.$e)(h._extraFilter,a)):a=h._extraFilter,yield h._ensureLoaded();const P=yield h._parent._getFilteredSet(o,s,a,u,_);let x;return h._checkCancelled(_),x=!0===I?new A.Z(P._candidates.slice(0).concat(P._known.slice(0)),[],!0===U&&P._ordered,h._clonePageDefinition(P.pagesDefinition)):new A.Z(P._candidates.slice(0),P._known.slice(0),!0===U&&P._ordered,h._clonePageDefinition(P.pagesDefinition)),x})()}_reformulateWithoutAdaptions(o){const s={cannot:!1,where:o};if(null!==o)for(const a of this.adaptedFields)if(!0===(0,w.hq)(o,a.field.name)){const u=a.rewriteSql(o,this);if(!0!==u.rewritten){s.cannot=!0,s.where=null;break}s.where=u.where}return s}_stat(o,s,a,u,_,h,I){var j=this;return(0,F.Z)(function*(){let U=!1,P=j._reformulateWithoutAdaptions(s);if(U=P.cannot,s=P.where,P=j._reformulateWithoutAdaptions(_),U=U||P.cannot,null!==(_=P.where)?null!==j._extraFilter&&(_=(0,w.$e)(j._extraFilter,_)):_=j._extraFilter,!0===U)return null===_&&""===a&&null===u?j._manualStat(o,s,h,I):{calculated:!1};const x=yield j._parent._stat(o,s,a,u,_,h,I);return!1===x.calculated?null===_&&""===a&&null===u?j._manualStat(o,s,h,I):{calculated:!1}:x})()}_canDoAggregates(o,s,a,u,_){var h=this;return(0,F.Z)(function*(){if(null===h._parent)return!1;for(let U=0;U<o.length;U++)for(const P of h.adaptedFields)if(o[U].toLowerCase()===P.field.name.toLowerCase()&&!(P instanceof m))return!1;const I=[];for(let U=0;U<s.length;U++){const P=s[U];if(null!==P.workingexpr){const x=h._reformulateWithoutAdaptions(P.workingexpr);if(x.cannot)return!1;const M=P.clone();M.workingexpr=x.where,I.push(M)}else I.push(P)}const j=h._reformulateWithoutAdaptions(_);return!j.cannot&&(null!==(_=j.where)?null!==h._extraFilter&&(_=(0,w.$e)(h._extraFilter,_)):_=h._extraFilter,h._parent._canDoAggregates(o,I,a,u,_))})()}_getAggregatePagesDataSourceDefinition(o,s,a,u,_,h,I){var j=this;return(0,F.Z)(function*(){if(null===j._parent)throw new Error("Should never be called");const U=[];for(let x=0;x<s.length;x++){const M=s[x];if(null!==M.workingexpr){const B=j._reformulateWithoutAdaptions(M.workingexpr);if(B.cannot)throw new Error("Should never be called");const te=M.clone();te.workingexpr=B.where,U.push(te)}else U.push(M)}const P=j._reformulateWithoutAdaptions(_);if(P.cannot)throw new Error("Should never be called");return null!==(_=P.where)?null!==j._extraFilter&&(_=(0,w.$e)(j._extraFilter,_)):_=j._extraFilter,j._parent._getAggregatePagesDataSourceDefinition(o,U,a,u,_,h,I)})()}}},53997:(X,K,g)=>{g.d(K,{Z:()=>T});var F=g(15861),Q=g(49086),W=g(91510),R=g(77132),A=g(83947),N=g(10699),w=g(10410),D=g(65234);class T extends Q.Z{constructor(m){super(m),this.declaredClass="esri.arcade.featureset.actions.AttributeFilter",this._maxProcessing=1e3,this._parent=m.parentfeatureset,m.whereclause instanceof w.WhereClause?(this._whereclause=m.whereclause,this._whereClauseFunction=null):(this._whereClauseFunction=m.whereclause,this._whereclause=null)}_initialiseFeatureSet(){null!==this._parent?(this.fields=this._parent.fields.slice(0),this.geometryType=this._parent.geometryType,this.objectIdField=this._parent.objectIdField,this.globalIdField=this._parent.globalIdField,this.spatialReference=this._parent.spatialReference,this.hasM=this._parent.hasM,this.hasZ=this._parent.hasZ,this.typeIdField=this._parent.typeIdField,this.types=this._parent.types):(this.fields=[],this.typeIdField="",this.objectIdField="",this.globalIdField="",this.spatialReference=new D.Z({wkid:4326}),this.geometryType=R.Qk.point)}_getSet(m){var p=this;return(0,F.Z)(function*(){if(null===p._wset){yield p._ensureLoaded();const C=yield p._parent._getFilteredSet("",null,p._whereclause,null,m);return p._checkCancelled(m),p._wset=null!==p._whereClauseFunction?new W.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],C._ordered,p._clonePageDefinition(C.pagesDefinition)):new W.Z(C._candidates.slice(0),C._known.slice(0),C._ordered,p._clonePageDefinition(C.pagesDefinition)),p._wset}return p._wset})()}_isInFeatureSet(m){let p=this._parent._isInFeatureSet(m);return p===R.dj.NotInFeatureSet?p:(p=this._idstates[m],void 0===p?R.dj.Unknown:p)}_getFeature(m,p,C){return this._parent._getFeature(m,p,C)}_getFeatures(m,p,C,f){return this._parent._getFeatures(m,p,C,f)}_featureFromCache(m){return this._parent._featureFromCache(m)}executeWhereClause(m){return this._whereclause.testFeature(m)}executeWhereClauseDeferred(m){var p=this;return(0,F.Z)(function*(){if(null!==p._whereClauseFunction){const C=p._whereClauseFunction(m);return(0,N.y8)(C),C}return p.executeWhereClause(m)})()}_fetchAndRefineFeatures(m,p,C){var f=this;return(0,F.Z)(function*(){const E=new W.Z([],m,!1,null),v=Math.min(p,m.length);if(yield f._parent._getFeatures(E,-1,v,C),f._checkCancelled(C),null==f._whereClauseFunction){for(let s=0;s<v;s++){const a=f._parent._featureFromCache(m[s]);f._idstates[m[s]]=!0===f.executeWhereClause(a)?R.dj.InFeatureSet:R.dj.NotInFeatureSet}return"success"}const o=[];for(let s=0;s<v;s++){const a=f._parent._featureFromCache(m[s]);o.push(yield f.executeWhereClauseDeferred(a))}for(let s=0;s<p;s++)f._idstates[m[s]]=!0===o[s]?R.dj.InFeatureSet:R.dj.NotInFeatureSet;return"success"})()}_getFilteredSet(m,p,C,f,E){var v=this;return(0,F.Z)(function*(){null!==v._whereClauseFunction||(null!==C?null!==v._whereclause&&(C=(0,A.$e)(v._whereclause,C)):C=v._whereclause),yield v._ensureLoaded();const o=yield v._parent._getFilteredSet(m,p,C,f,E);let s;return v._checkCancelled(E),s=null!==v._whereClauseFunction?new W.Z(o._candidates.slice(0).concat(o._known.slice(0)),[],o._ordered,v._clonePageDefinition(o.pagesDefinition)):new W.Z(o._candidates.slice(0),o._known.slice(0),o._ordered,v._clonePageDefinition(o.pagesDefinition)),s})()}_stat(m,p,C,f,E,v,o){var s=this;return(0,F.Z)(function*(){if(null!==s._whereClauseFunction)return null===E&&""===C&&null===f?s._manualStat(m,p,v,o):{calculated:!1};let a=s._whereclause;null!==E&&null!==s._whereclause&&(a=(0,A.$e)(s._whereclause,E));const u=yield s._parent._stat(m,p,C,f,a,v,o);return!1===u.calculated?null===E&&""===C&&null===f?s._manualStat(m,p,v,o):{calculated:!1}:u})()}_canDoAggregates(m,p,C,f,E){var v=this;return(0,F.Z)(function*(){return null===v._whereClauseFunction&&(null!==E?null!==v._whereclause&&(E=(0,A.$e)(v._whereclause,E)):E=v._whereclause,null!==v._parent&&v._parent._canDoAggregates(m,p,C,f,E))})()}_getAggregatePagesDataSourceDefinition(m,p,C,f,E,v,o){var s=this;return(0,F.Z)(function*(){if(null===s._parent)throw new Error("Should never be called");return null!==E?null!==s._whereclause&&(E=(0,A.$e)(s._whereclause,E)):E=s._whereclause,s._parent._getAggregatePagesDataSourceDefinition(m,p,C,f,E,v,o)})()}static registerAction(){Q.Z._featuresetFunctions.filter=function(m){if("function"==typeof m)return new T({parentfeatureset:this,whereclause:m});let p=null;return m instanceof w.WhereClause&&(p=m),new T({parentfeatureset:this,whereclause:p})}}}},95896:(X,K,g)=>{g.d(K,{Z:()=>N});var F=g(15861),Q=g(47562),W=g(49086),R=g(91510),A=g(57366);class N extends W.Z{constructor(D){super(D),this._orderbyclause=null,this.declaredClass="esri.arcade.featureset.actions.OrderBy",this._maxProcessing=100,this._orderbyclause=D.orderbyclause,this._parent=D.parentfeatureset}_getSet(D){var T=this;return(0,F.Z)(function*(){if(null===T._wset){yield T._ensureLoaded();const O=yield T._getFilteredSet("",null,null,T._orderbyclause,D);return T._checkCancelled(D),T._wset=O,T._wset}return T._wset})()}manualOrderSet(D,T){var O=this;return(0,F.Z)(function*(){const m=yield O.getIdColumnDictionary(D,[],-1,T);O._orderbyclause.order(m);const p=new R.Z([],[],!0,null);for(let C=0;C<m.length;C++)p._known.push(m[C].id);return p})()}getIdColumnDictionary(D,T,O,m){var p=this;return(0,F.Z)(function*(){if(O<D._known.length-1){const C=p._maxQueryRate();if("GETPAGES"===D._known[O+1])return yield(0,Q.X)(p._parent._expandPagedSet(D,C,0,0,m)),p.getIdColumnDictionary(D,T,O,m);let f=O+1;const E=[];for(;f<D._known.length&&"GETPAGES"!==D._known[f];)E.push(D._known[f]),f++;O+=E.length;const v=yield(0,Q.X)(p._parent._getFeatureBatch(E,m));p._checkCancelled(m);for(const o of v)T.push({id:o.attributes[p.objectIdField],feature:o});return p.getIdColumnDictionary(D,T,O,m)}return D._candidates.length>0?(yield(0,Q.X)(p._refineSetBlock(D,p._maxProcessingRate(),m)),p._checkCancelled(m),p.getIdColumnDictionary(D,T,O,m)):T})()}_isInFeatureSet(D){return this._parent._isInFeatureSet(D)}_getFeatures(D,T,O,m){return this._parent._getFeatures(D,T,O,m)}_featureFromCache(D){if(void 0===this._featureCache[D]){const T=this._parent._featureFromCache(D);return void 0===T?void 0:null===T?null:(this._featureCache[D]=T,T)}return this._featureCache[D]}_fetchAndRefineFeatures(){return(0,F.Z)(function*(){throw new Error("Fetch and Refine should not be called in this featureset")})()}_getFilteredSet(D,T,O,m,p){var C=this;return(0,F.Z)(function*(){yield C._ensureLoaded();const f=yield C._parent._getFilteredSet(D,T,O,null===m?C._orderbyclause:m,p);C._checkCancelled(p);const E=new R.Z(f._candidates.slice(0),f._known.slice(0),f._ordered,C._clonePageDefinition(f.pagesDefinition));let v=!0;if(f._candidates.length>0&&(v=!1),!1===E._ordered){let o=yield C.manualOrderSet(E,p);return!1===v&&(null===T&&null===O||(o=new R.Z(o._candidates.slice(0).concat(o._known.slice(0)),[],o._ordered,C._clonePageDefinition(o.pagesDefinition)))),o}return E})()}static registerAction(){W.Z._featuresetFunctions.orderBy=function(D){return""===D?this:new N({parentfeatureset:this,orderbyclause:new A.Z(D)})}}}},79429:(X,K,g)=>{g.d(K,{Z:()=>A});var F=g(15861),Q=g(49086),W=g(91510),R=g(77132);class A extends Q.Z{constructor(w){super(w),this._topnum=0,this.declaredClass="esri.arcade.featureset.actions.Top",this._countedin=0,this._maxProcessing=100,this._topnum=w.topnum,this._parent=w.parentfeatureset}_getSet(w){var D=this;return(0,F.Z)(function*(){if(null===D._wset){yield D._ensureLoaded();const T=yield D._parent._getSet(w);return D._wset=new W.Z(T._candidates.slice(0),T._known.slice(0),!1,D._clonePageDefinition(T.pagesDefinition)),D._setKnownLength(D._wset)>D._topnum&&(D._wset._known=D._wset._known.slice(0,D._topnum)),D._setKnownLength(D._wset)>=D._topnum&&(D._wset._candidates=[]),D._wset}return D._wset})()}_setKnownLength(w){return w._known.length>0&&"GETPAGES"===w._known[w._known.length-1]?w._known.length-1:w._known.length}_isInFeatureSet(w){const D=this._parent._isInFeatureSet(w);if(D===R.dj.NotInFeatureSet)return D;const T=this._idstates[w];return T===R.dj.InFeatureSet||T===R.dj.NotInFeatureSet?T:D===R.dj.InFeatureSet&&void 0===T?this._countedin<this._topnum?(this._idstates[w]=R.dj.InFeatureSet,this._countedin++,R.dj.InFeatureSet):(this._idstates[w]=R.dj.NotInFeatureSet,R.dj.NotInFeatureSet):R.dj.Unknown}_expandPagedSet(w,D,T,O,m){var p=this;return(0,F.Z)(function*(){if(null===p._parent)throw new Error("Parent Paging not implemented");if(D>p._topnum&&(D=p._topnum),p._countedin>=p._topnum&&w.pagesDefinition.internal.set.length<=w.pagesDefinition.resultOffset){let f=w._known.length;return f>0&&"GETPAGES"===w._known[f-1]&&(w._known.length=f-1),f=w._candidates.length,f>0&&"GETPAGES"===w._candidates[f-1]&&(w._candidates.length=f-1),"success"}const C=yield p._parent._expandPagedSet(w,D,T,O,m);return p._setKnownLength(w)>p._topnum&&(w._known.length=p._topnum),p._setKnownLength(w)>=p._topnum&&(w._candidates.length=0),C})()}_getFeatures(w,D,T,O){var m=this;return(0,F.Z)(function*(){const p=[],C=m._maxQueryRate();if(!0===m._checkIfNeedToExpandKnownPage(w,C))return yield m._expandPagedSet(w,C,0,0,O),m._getFeatures(w,D,T,O);-1!==D&&void 0===m._featureCache[D]&&p.push(D);let f=0;for(let o=w._lastFetchedIndex;o<w._known.length&&(f++,f<=T&&(w._lastFetchedIndex+=1),!(void 0===m._featureCache[w._known[o]]&&(w._known[o]!==D&&p.push(w._known[o]),p.length>C)));o++);if(0===p.length)return"success";const E=new W.Z([],p,!1,null),v=Math.min(p.length,T);yield m._parent._getFeatures(E,-1,v,O);for(let o=0;o<v;o++){const s=m._parent._featureFromCache(p[o]);void 0!==s&&(m._featureCache[p[o]]=s)}return"success"})()}_getFilteredSet(w,D,T,O,m){var p=this;return(0,F.Z)(function*(){yield p._ensureLoaded();const C=yield p._getSet(m);return new W.Z(C._candidates.slice(0).concat(C._known.slice(0)),[],!1,p._clonePageDefinition(C.pagesDefinition))})()}_refineKnowns(w,D){let T=0,O=null;const m=[];for(let p=0;p<w._candidates.length;p++){const C=this._isInFeatureSet(w._candidates[p]);if(C===R.dj.InFeatureSet){if(w._known.push(w._candidates[p]),T+=1,null===O?O={start:p,end:p}:O.end===p-1?O.end=p:(m.push(O),O={start:p,end:p}),w._known.length>=this._topnum)break}else if(C===R.dj.NotInFeatureSet)null===O?O={start:p,end:p}:O.end===p-1?O.end=p:(m.push(O),O={start:p,end:p}),T+=1;else if(C===R.dj.Unknown)break;if(T>=D)break}null!==O&&m.push(O);for(let p=m.length-1;p>=0;p--)w._candidates.splice(m[p].start,m[p].end-m[p].start+1);this._setKnownLength(w)>this._topnum&&(w._known=w._known.slice(0,this._topnum)),this._setKnownLength(w)>=this._topnum&&(w._candidates=[])}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}static registerAction(){Q.Z._featuresetFunctions.top=function(w){return new A({parentfeatureset:this,topnum:w})}}}},16776:(X,K,g)=>{g.d(K,{Z:()=>p});var F=g(15861),Q=g(88879),W=g(49086),R=g(91510),A=g(77132),N=g(83947),w=g(21674),D=g(32258),T=g(41638),O=g(36255),m=g(84952);class p extends W.Z{constructor(f){super(f),this.declaredClass="esri.arcade.featureset.sources.FeatureLayerMemory",this._removeGeometry=!1,this._overrideFields=null,this._forceIsTable=!1,f.spatialReference&&(this.spatialReference=f.spatialReference),this._transparent=!0,this._maxProcessing=1e3,this._layer=f.layer,this._wset=null,!0===f.isTable&&(this._forceIsTable=!0),void 0!==f.outFields&&(this._overrideFields=f.outFields),void 0!==f.includeGeometry&&(this._removeGeometry=!1===f.includeGeometry)}_maxQueryRate(){return A.tI}end(){return this._layer}optimisePagingFeatureQueries(){}loadImpl(){var f=this;return(0,F.Z)(function*(){return!0===f._layer.loaded?(f._initialiseFeatureSet(),f):(yield f._layer.load(),f._initialiseFeatureSet(),f)})()}get gdbVersion(){return""}_initialiseFeatureSet(){if(null==this.spatialReference&&(this.spatialReference=this._layer.spatialReference),this.geometryType=this._layer.geometryType,this.fields=this._layer.fields.slice(0),this._layer.outFields&&(1!==this._layer.outFields.length||"*"!==this._layer.outFields[0])){const f=[];for(const E of this.fields)if("oid"===E.type)f.push(E);else for(const v of this._layer.outFields)if(v.toLowerCase()===E.name.toLowerCase()){f.push(E);break}this.fields=f}if(null!==this._overrideFields)if(1===this._overrideFields.length&&"*"===this._overrideFields[0])this._overrideFields=null;else{const f=[],E=[];for(const v of this.fields)if("oid"===v.type)f.push(v),E.push(v.name);else for(const o of this._overrideFields)if(o.toLowerCase()===v.name.toLowerCase()){f.push(v),E.push(v.name);break}this.fields=f,this._overrideFields=E}this.objectIdField=this._layer.objectIdField;for(const f of this.fields)"global-id"===f.type&&(this.globalIdField=f.name);this.hasM=this._layer.supportsM,this.hasZ=this._layer.supportsZ,this._databaseType=A.Bj.Standardised,this.typeIdField=this._layer.typeIdField,this.types=this._layer.types}isTable(){return this._forceIsTable||this._layer.isTable||"table"===this._layer.type||!this._layer.geometryType}_isInFeatureSet(){return A.dj.InFeatureSet}_candidateIdTransform(f){return f}_getSet(f){var E=this;return(0,F.Z)(function*(){if(null===E._wset){yield E._ensureLoaded();const v=yield E._getFilteredSet("",null,null,null,f);return E._wset=v,v}return E._wset})()}_changeFeature(f){const E={};for(const v of this.fields)E[v.name]=f.attributes[v.name];return new Q.Z({geometry:!0===this._removeGeometry?null:f.geometry,attributes:E})}_getFilteredSet(f,E,v,o,s){var a=this;return(0,F.Z)(function*(){let u="",_=!1;if(null!==o&&(u=o.constructClause(),_=!0),a.isTable()&&E&&null!==f&&""!==f)return new R.Z([],[],!0,null);const h=new m.Z;h.where=null===v?null===E?"1=1":"":(0,N.zR)(v,A.Bj.Standardised),h.spatialRelationship=a._makeRelationshipEnum(f),h.outSpatialReference=a.spatialReference,h.orderByFields=""!==u?u.split(","):null,h.geometry=null===E?null:E,h.returnGeometry=!0,h.relationParameter=a._makeRelationshipParam(f);const I=yield a._layer.queryFeatures(h);if(null===I)return new R.Z([],[],_,null);a._checkCancelled(s);const j=[];return I.features.forEach(U=>{const P=U.attributes[a._layer.objectIdField];j.push(P),a._featureCache[P]=a._changeFeature(U)}),new R.Z([],j,_,null)})()}_makeRelationshipEnum(f){if(f.includes("esriSpatialRelRelation"))return"relation";switch(f){case"esriSpatialRelRelation":return"relation";case"esriSpatialRelIntersects":return"intersects";case"esriSpatialRelContains":return"contains";case"esriSpatialRelOverlaps":return"overlaps";case"esriSpatialRelWithin":return"within";case"esriSpatialRelTouches":return"touches";case"esriSpatialRelCrosses":return"crosses";case"esriSpatialRelEnvelopeIntersects":return"envelope-intersects"}return f}_makeRelationshipParam(f){return f.includes("esriSpatialRelRelation")?f.split(":")[1]:""}_queryAllFeatures(){var f=this;return(0,F.Z)(function*(){if(f._wset)return f._wset;const E=new m.Z;if(E.where="1=1",yield f._ensureLoaded(),f._layer.source&&f._layer.source.items){const s=[];return f._layer.source.items.forEach(a=>{const u=a.attributes[f._layer.objectIdField];s.push(u),f._featureCache[u]=f._changeFeature(a)}),f._wset=new R.Z([],s,!1,null),f._wset}const v=yield f._layer.queryFeatures(E),o=[];return v.features.forEach(s=>{const a=s.attributes[f._layer.objectIdField];o.push(a),f._featureCache[a]=f._changeFeature(s)}),f._wset=new R.Z([],o,!1,null),f._wset})()}_getFeatures(f,E,v){var o=this;return(0,F.Z)(function*(){const s=[];-1!==E&&void 0===o._featureCache[E]&&s.push(E);for(let a=f._lastFetchedIndex;a<f._known.length&&(f._lastFetchedIndex+=1,!(void 0===o._featureCache[f._known[a]]&&(f._known[a]!==E&&s.push(f._known[a]),s.length>v)));a++);if(0===s.length)return"success";throw new Error("Unaccounted for Features. Not in Feature Collection")})()}_refineSetBlock(f){return(0,F.Z)(function*(){return f})()}_stat(){return(0,F.Z)(function*(){return{calculated:!1}})()}_canDoAggregates(){return(0,F.Z)(function*(){return!1})()}relationshipMetaData(){return[]}static _cloneAttr(f){const E={};for(const v in f)E[v]=f[v];return E}nativeCapabilities(){return{title:this._layer.title,canQueryRelated:!1,source:this,capabilities:this._layer.capabilities,databaseType:this._databaseType,requestStandardised:!0}}static create(f,E){let v=f.layerDefinition.objectIdField;const o=f.layerDefinition.typeIdField?f.layerDefinition.typeIdField:"",s=[];if(f.layerDefinition.types)for(const P of f.layerDefinition.types)s.push(T.Z.fromJSON(P));let a=f.layerDefinition.geometryType;void 0===a&&(a=f.featureSet.geometryType||"");let u=f.featureSet.features;const _=E.toJSON();if(""===v||void 0===v){let P=!1;for(const x of f.layerDefinition.fields)if("oid"===x.type||"esriFieldTypeOID"===x.type){v=x.name,P=!0;break}if(!1===P){let x="FID",M=!0,B=0;for(;M;){let $=!0;for(const me of f.layerDefinition.fields)if(me.name===x){$=!1;break}!0===$?M=!1:(B++,x="FID"+B.toString())}f.layerDefinition.fields.push({type:"esriFieldTypeOID",name:x,alias:x});const te=[];for(let $=0;$<u.length;$++)te.push({geometry:f.featureSet.features[$].geometry,attributes:f.featureSet.features[$].attributes?this._cloneAttr(f.featureSet.features[$].attributes):{}}),te[$].attributes[x]=$;u=te,v=x}}const h=[];for(const P of f.layerDefinition.fields)h.push(P instanceof O.Z?P:O.Z.fromJSON(P));let I=a;switch(I){case"esriGeometryPoint":I="point";break;case"esriGeometryPolyline":I="polyline";break;case"esriGeometryPolygon":I="polygon";break;case"esriGeometryExtent":I="extent";break;case"esriGeometryMultipoint":I="multipoint"}for(const P of u)P.geometry&&!(P.geometry instanceof w.Z)&&(P.geometry.type=I,void 0===P.geometry.spatialReference&&(P.geometry.spatialReference=_));const j={outFields:["*"],source:u,fields:h,types:s,typeIdField:o,objectIdField:v,spatialReference:E};j.geometryType=I||"point";const U=new D.default(j);return new p({layer:U,spatialReference:E,isTable:null===I||""===I})}queryAttachments(){return(0,F.Z)(function*(){return[]})()}getFeatureByObjectId(f){var E=this;return(0,F.Z)(function*(){const v=new m.Z;v.where=E.objectIdField+"="+f.toString();const o=yield E._layer.queryFeatures(v);return 1===o.features.length?o.features[0]:null})()}getOwningSystemUrl(){return(0,F.Z)(function*(){return""})()}getIdentityUser(){return(0,F.Z)(function*(){return""})()}}},57366:(X,K,g)=>{function F(W,R){return W===R?0:null===W?-1:null===R?1:W<R?-1:1}g.d(K,{Z:()=>Q});class Q{constructor(R){const A=R.split(",");this._fields=[],this._directions=[];for(let N=0;N<A.length;N++){const w=A[N].match(/\S+/g);this._fields.push(w[0]),2===w.length?"asc"===w[1].toLowerCase()?this._directions.push(1):this._directions.push(0):this._directions.push(1)}}constructClause(){let R="";for(let A=0;A<this._fields.length;A++)0!==A&&(R+=","),R+=this._fields[A],R+=1===this._directions[A]?" ASC":" DESC";return R}order(R){R.sort((A,N)=>{for(let w=0;w<this._fields.length;w++){const D=this.featureValue(A.feature,this._fields[w],w),T=this.featureValue(N.feature,this._fields[w],w);let O=0;if(O=1===this._directions[w]?F(D,T):-1*F(D,T),0!==O)return O}return 0})}scanForField(R){for(let A=0;A<this._fields.length;A++)if(this._fields[A].toLowerCase().trim()===R.toLowerCase().trim())return!0;return!1}replaceFields(R){let A="";for(let N=0;N<this._fields.length;N++){0!==N&&(A+=",");let w=this._fields[N];for(const D of R)if(w.toLowerCase()===D.field.toLowerCase()){w=D.newfield;break}A+=w,A+=1===this._directions[N]?" ASC":" DESC"}return new Q(A)}featureValue(R,A,N){const w=R.attributes[A];if(void 0!==w)return w;for(const D in R.attributes)if(A.toLowerCase()===D.toLowerCase())return this._fields[N]=D,R.attributes[D];return null}}},50011:(X,K,g)=>{g.d(K,{F:()=>v,M:()=>F});const F={Base64:0,Hex:1,String:2,Raw:3};function R(o,s){const a=(65535&o)+(65535&s);return(o>>16)+(s>>16)+(a>>16)<<16|65535&a}function O(o,s,a,u,_,h){return R(function T(o,s){return o<<s|o>>>32-s}(R(R(s,o),R(u,h)),_),a)}function m(o,s,a,u,_,h,I){return O(s&a|~s&u,o,s,_,h,I)}function p(o,s,a,u,_,h,I){return O(s&u|a&~u,o,s,_,h,I)}function C(o,s,a,u,_,h,I){return O(s^a^u,o,s,_,h,I)}function f(o,s,a,u,_,h,I){return O(a^(s|~u),o,s,_,h,I)}function v(o,s=F.Hex){const a=s||F.Base64,u=function E(o,s){o[s>>5]|=128<<s%32,o[14+(s+64>>>9<<4)]=s;let a=1732584193,u=-271733879,_=-1732584194,h=271733878;for(let I=0;I<o.length;I+=16){const j=a,U=u,P=_,x=h;a=m(a,u,_,h,o[I+0],7,-680876936),h=m(h,a,u,_,o[I+1],12,-389564586),_=m(_,h,a,u,o[I+2],17,606105819),u=m(u,_,h,a,o[I+3],22,-1044525330),a=m(a,u,_,h,o[I+4],7,-176418897),h=m(h,a,u,_,o[I+5],12,1200080426),_=m(_,h,a,u,o[I+6],17,-1473231341),u=m(u,_,h,a,o[I+7],22,-45705983),a=m(a,u,_,h,o[I+8],7,1770035416),h=m(h,a,u,_,o[I+9],12,-1958414417),_=m(_,h,a,u,o[I+10],17,-42063),u=m(u,_,h,a,o[I+11],22,-1990404162),a=m(a,u,_,h,o[I+12],7,1804603682),h=m(h,a,u,_,o[I+13],12,-40341101),_=m(_,h,a,u,o[I+14],17,-1502002290),u=m(u,_,h,a,o[I+15],22,1236535329),a=p(a,u,_,h,o[I+1],5,-165796510),h=p(h,a,u,_,o[I+6],9,-1069501632),_=p(_,h,a,u,o[I+11],14,643717713),u=p(u,_,h,a,o[I+0],20,-373897302),a=p(a,u,_,h,o[I+5],5,-701558691),h=p(h,a,u,_,o[I+10],9,38016083),_=p(_,h,a,u,o[I+15],14,-660478335),u=p(u,_,h,a,o[I+4],20,-405537848),a=p(a,u,_,h,o[I+9],5,568446438),h=p(h,a,u,_,o[I+14],9,-1019803690),_=p(_,h,a,u,o[I+3],14,-187363961),u=p(u,_,h,a,o[I+8],20,1163531501),a=p(a,u,_,h,o[I+13],5,-1444681467),h=p(h,a,u,_,o[I+2],9,-51403784),_=p(_,h,a,u,o[I+7],14,1735328473),u=p(u,_,h,a,o[I+12],20,-1926607734),a=C(a,u,_,h,o[I+5],4,-378558),h=C(h,a,u,_,o[I+8],11,-2022574463),_=C(_,h,a,u,o[I+11],16,1839030562),u=C(u,_,h,a,o[I+14],23,-35309556),a=C(a,u,_,h,o[I+1],4,-1530992060),h=C(h,a,u,_,o[I+4],11,1272893353),_=C(_,h,a,u,o[I+7],16,-155497632),u=C(u,_,h,a,o[I+10],23,-1094730640),a=C(a,u,_,h,o[I+13],4,681279174),h=C(h,a,u,_,o[I+0],11,-358537222),_=C(_,h,a,u,o[I+3],16,-722521979),u=C(u,_,h,a,o[I+6],23,76029189),a=C(a,u,_,h,o[I+9],4,-640364487),h=C(h,a,u,_,o[I+12],11,-421815835),_=C(_,h,a,u,o[I+15],16,530742520),u=C(u,_,h,a,o[I+2],23,-995338651),a=f(a,u,_,h,o[I+0],6,-198630844),h=f(h,a,u,_,o[I+7],10,1126891415),_=f(_,h,a,u,o[I+14],15,-1416354905),u=f(u,_,h,a,o[I+5],21,-57434055),a=f(a,u,_,h,o[I+12],6,1700485571),h=f(h,a,u,_,o[I+3],10,-1894986606),_=f(_,h,a,u,o[I+10],15,-1051523),u=f(u,_,h,a,o[I+1],21,-2054922799),a=f(a,u,_,h,o[I+8],6,1873313359),h=f(h,a,u,_,o[I+15],10,-30611744),_=f(_,h,a,u,o[I+6],15,-1560198380),u=f(u,_,h,a,o[I+13],21,1309151649),a=f(a,u,_,h,o[I+4],6,-145523070),h=f(h,a,u,_,o[I+11],10,-1120210379),_=f(_,h,a,u,o[I+2],15,718787259),u=f(u,_,h,a,o[I+9],21,-343485551),a=R(a,j),u=R(u,U),_=R(_,P),h=R(h,x)}return[a,u,_,h]}(function A(o){const s=[];for(let a=0,u=8*o.length;a<u;a+=8)s[a>>5]|=(255&o.charCodeAt(a/8))<<a%32;return s}(o),8*o.length);switch(a){case F.Raw:return u;case F.Hex:return function w(o){const s="0123456789abcdef",a=[];for(let u=0,_=4*o.length;u<_;u++)a.push(s.charAt(o[u>>2]>>u%4*8+4&15)+s.charAt(o[u>>2]>>u%4*8&15));return a.join("")}(u);case F.String:return function N(o){const s=[];for(let a=0,u=32*o.length;a<u;a+=8)s.push(String.fromCharCode(o[a>>5]>>>a%32&255));return s.join("")}(u);case F.Base64:return function D(o){const u=[];for(let _=0,h=4*o.length;_<h;_+=3){const I=(o[_>>2]>>_%4*8&255)<<16|(o[_+1>>2]>>(_+1)%4*8&255)<<8|o[_+2>>2]>>(_+2)%4*8&255;for(let j=0;j<4;j++)u.push(8*_+6*j>32*o.length?"=":"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".charAt(I>>6*(3-j)&63))}return u.join("")}(u)}}},90463:(X,K,g)=>{g.d(K,{P:()=>A});var F=g(15861),Q=g(2618),W=g(20477),R=g(84952);function A(w,D,T){return N.apply(this,arguments)}function N(){return(N=(0,F.Z)(function*(w,D,T){const O=(0,Q.en)(w);return(0,W.executeQueryForCount)(O,R.Z.from(D),ne({},T)).then(m=>m.data.count)})).apply(this,arguments)}},24865:(X,K,g)=>{g.d(K,{G:()=>A});var F=g(15861),Q=g(2618),W=g(20477),R=g(84952);function A(w,D,T){return N.apply(this,arguments)}function N(){return(N=(0,F.Z)(function*(w,D,T){const O=(0,Q.en)(w);return(0,W.executeQueryForIds)(O,R.Z.from(D),ne({},T)).then(m=>m.data.objectIds)})).apply(this,arguments)}}}]);